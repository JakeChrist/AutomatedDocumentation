<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>chunk_utils</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul>
        <li><a href="index.html"><strong>üè† Project Overview</strong></a></li>
<li><a href="cache.html">cache</a></li>
<li><a href="chunk_utils.html">chunk_utils</a></li>
<li><a href="docgenerator.html">docgenerator</a></li>
<li><a href="explaincode.html">explaincode</a></li>
<li><a href="gui_wrapper.html">gui_wrapper</a></li>
<li><a href="html_writer.html">html_writer</a></li>
<li><a href="llm_client.html">llm_client</a></li>
<li><a href="manual_utils.html">manual_utils</a></li>
<li><a href="parser_matlab.html">parser_matlab</a></li>
<li><a href="parser_python.html">parser_python</a></li>
<li><a href="reviewer.html">reviewer</a></li>
<li><a href="scanner.html">scanner</a></li>
<li><a href="setup.html">setup</a></li>
<li><a href="summarize_utils.html">summarize_utils</a></li>
<li><a href="test_cache.html">test_cache</a></li>
<li><a href="test_chunk_utils.html">test_chunk_utils</a></li>
<li><a href="test_docgenerator.html">test_docgenerator</a></li>
<li><a href="test_docgenerator_subclasses.html">test_docgenerator_subclasses</a></li>
<li><a href="test_explaincode.html">test_explaincode</a></li>
<li><a href="test_html_writer.html">test_html_writer</a></li>
<li><a href="test_integration.html">test_integration</a></li>
<li><a href="test_llm_client.html">test_llm_client</a></li>
<li><a href="test_manual_utils.html">test_manual_utils</a></li>
<li><a href="test_parser_matlab.html">test_parser_matlab</a></li>
<li><a href="test_parser_python.html">test_parser_python</a></li>
<li><a href="test_reviewer.html">test_reviewer</a></li>
<li><a href="test_scanner.html">test_scanner</a></li>
        </ul>
    </div>
    <div class="content">
        <h1>chunk_utils</h1>
        <p>This module provides utility functions for tokenization and text chunking. It includes:

1. `get_tokenizer()`: Returns a tokenizer object for estimating token counts, using the `tiktoken` library if available.
2. `_split_blocks(text: str) -&gt; List[str]`: Splits Markdown text into paragraphs, headings, and fenced code blocks.
3. `_split_long_block(block: str, tokenizer, chunk_size_tokens: int) -&gt; List[str]`: Fallback function to split long blocks by approximate character length if they exceed the specified token size.
4. `chunk_text(text: str, tokenizer, chunk_size_tokens: int) -&gt; List[str]`: Splits text into chunks roughly of the specified token size, honoring natural break points like blank lines and Markdown headings. If a block exceeds the token size, it falls back to splitting by character length.</p>
<h2>Functions</h2>
<h3 id="get_tokenizer">get_tokenizer()</h3>
<p>The function `get_tokenizer` returns a tokenizer object used for estimating token counts. It first attempts to import and use the `tiktoken` library with the &quot;cl100k_base&quot; encoding. If successful, it returns this tokenizer. If `tiktoken` is not available or fails, it falls back to using a simple tokenizer that splits text into words by spaces for encoding and joins them back together for decoding. If both attempts fail, it prints a warning message indicating that token counts will be approximate and returns a simple tokenizer as a fallback.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_tokenizer</span>():
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a tokenizer object used for estimating token counts.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">if</span> tiktoken <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - optional branch</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> tiktoken<span style="color: #666666">.</span>get_encoding(<span style="color: #BA2121">&quot;cl100k_base&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - fallback if model unknown or offline</span>
            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000; font-weight: bold">return</span> tiktoken<span style="color: #666666">.</span>encoding_for_model(<span style="color: #BA2121">&quot;gpt-3.5-turbo&quot;</span>)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                <span style="color: #008000; font-weight: bold">pass</span>

    <span style="color: #008000">print</span>(
        <span style="color: #BA2121">&quot;[WARNING] tiktoken is not installed or could not be loaded; token counts will be approximate.&quot;</span>,
        file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
    )

    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">_Simple</span>:
        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">encode</span>(<span style="color: #008000">self</span>, text: <span style="color: #008000">str</span>):
            <span style="color: #008000; font-weight: bold">return</span> text<span style="color: #666666">.</span>split()

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">decode</span>(<span style="color: #008000">self</span>, tokens):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(tokens)

    <span style="color: #008000; font-weight: bold">return</span> _Simple()
</code></pre>
<h3 id="_split_blocks">_split_blocks(text: str) -&gt; List[str]</h3>
<p>The function `_split_blocks` takes a string `text` as input and returns a list of Markdown blocks, which are separated into paragraphs, headings, and code fences. It processes the text line by line, identifying and grouping lines based on their content. Paragraphs are sequences of non-empty lines that do not start with a heading or a code fence. Headings are lines that start with one or more hash symbols (`#`). Code blocks are enclosed within triple backticks (```). The function strips leading and trailing whitespace from each block before returning the list of blocks.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_split_blocks</span>(text: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> List[<span style="color: #008000">str</span>]:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return Markdown ``text`` separated into paragraphs, headings and fences.&quot;&quot;&quot;</span>

    blocks: List[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    lines <span style="color: #666666">=</span> text<span style="color: #666666">.</span>splitlines()
    current: List[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    in_code <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>

    <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> lines:
        <span style="color: #008000; font-weight: bold">if</span> line<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;```&quot;</span>):
            <span style="color: #008000; font-weight: bold">if</span> in_code:  <span style="color: #3D7B7B; font-style: italic"># closing fence</span>
                current<span style="color: #666666">.</span>append(line)
                blocks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current)<span style="color: #666666">.</span>strip())
                current <span style="color: #666666">=</span> []
                in_code <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
            <span style="color: #008000; font-weight: bold">else</span>:  <span style="color: #3D7B7B; font-style: italic"># opening fence</span>
                <span style="color: #008000; font-weight: bold">if</span> current:
                    blocks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current)<span style="color: #666666">.</span>strip())
                    current <span style="color: #666666">=</span> []
                current<span style="color: #666666">.</span>append(line)
                in_code <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">if</span> in_code:
            current<span style="color: #666666">.</span>append(line)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">if</span> line<span style="color: #666666">.</span>strip() <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;&quot;</span>:
            <span style="color: #008000; font-weight: bold">if</span> current:
                blocks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current)<span style="color: #666666">.</span>strip())
                current <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">if</span> line<span style="color: #666666">.</span>lstrip()<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;#&quot;</span>):
            <span style="color: #008000; font-weight: bold">if</span> current:
                blocks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current)<span style="color: #666666">.</span>strip())
            blocks<span style="color: #666666">.</span>append(line<span style="color: #666666">.</span>strip())
            current <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">continue</span>

        current<span style="color: #666666">.</span>append(line)

    <span style="color: #008000; font-weight: bold">if</span> current:
        blocks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current)<span style="color: #666666">.</span>strip())

    <span style="color: #008000; font-weight: bold">return</span> [b <span style="color: #008000; font-weight: bold">for</span> b <span style="color: #AA22FF; font-weight: bold">in</span> blocks <span style="color: #008000; font-weight: bold">if</span> b]
</code></pre>
<h3 id="_split_long_block">_split_long_block(block: str, tokenizer, chunk_size_tokens: int) -&gt; List[str]</h3>
<p>This function `_split_long_block` takes a string `block`, a tokenizer, and an integer `chunk_size_tokens`. It encodes the block into tokens using the provided tokenizer. If the number of tokens is less than or equal to `chunk_size_tokens`, it returns the original block as a single element list. Otherwise, it calculates an average character length per token and determines a maximum chunk size in characters based on this average. The function then splits the block into chunks of up to `max_chars` characters and returns these chunks as a list.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_split_long_block</span>(block: <span style="color: #008000">str</span>, tokenizer, chunk_size_tokens: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> List[<span style="color: #008000">str</span>]:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Fallback splitter that uses a character based approximation.&quot;&quot;&quot;</span>

    tokens <span style="color: #666666">=</span> tokenizer<span style="color: #666666">.</span>encode(block)
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokens) <span style="color: #666666">&lt;=</span> chunk_size_tokens:
        <span style="color: #008000; font-weight: bold">return</span> [block]

    avg_chars <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #008000">len</span>(block) <span style="color: #666666">//</span> <span style="color: #008000">len</span>(tokens), <span style="color: #666666">1</span>)
    max_chars <span style="color: #666666">=</span> <span style="color: #008000">max</span>(chunk_size_tokens <span style="color: #666666">*</span> avg_chars, <span style="color: #666666">1</span>)
    <span style="color: #008000; font-weight: bold">return</span> [block[i : i <span style="color: #666666">+</span> max_chars] <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">0</span>, <span style="color: #008000">len</span>(block), max_chars)]
</code></pre>
<h3 id="chunk_text">chunk_text(text: str, tokenizer, chunk_size_tokens: int) -&gt; List[str]</h3>
<p>The function `chunk_text` splits a given text into chunks of approximately specified token size. It uses a tokenizer to count tokens and ensures that natural break points like blank lines, Markdown headings, and fenced code blocks are respected. If a single block exceeds the token limit, it falls back to splitting by character length. The function returns a list of chunked text strings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chunk_text</span>(text: <span style="color: #008000">str</span>, tokenizer, chunk_size_tokens: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> List[<span style="color: #008000">str</span>]:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Split ``text`` into chunks roughly ``chunk_size_tokens`` each.</span>

<span style="color: #BA2121; font-style: italic">    Natural break points such as blank lines, Markdown headings and fenced code</span>
<span style="color: #BA2121; font-style: italic">    blocks are honoured.  If a single block still exceeds ``chunk_size_tokens``</span>
<span style="color: #BA2121; font-style: italic">    the function falls back to splitting that block by approximate character</span>
<span style="color: #BA2121; font-style: italic">    length.</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>

    blocks <span style="color: #666666">=</span> _split_blocks(text)
    chunks: List[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    current: List[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    token_count <span style="color: #666666">=</span> <span style="color: #666666">0</span>

    <span style="color: #008000; font-weight: bold">for</span> block <span style="color: #AA22FF; font-weight: bold">in</span> blocks:
        block_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(block))
        <span style="color: #008000; font-weight: bold">if</span> token_count <span style="color: #666666">+</span> block_tokens <span style="color: #666666">&gt;</span> chunk_size_tokens <span style="color: #AA22FF; font-weight: bold">and</span> current:
            chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))
            current <span style="color: #666666">=</span> []
            token_count <span style="color: #666666">=</span> <span style="color: #666666">0</span>

        <span style="color: #008000; font-weight: bold">if</span> block_tokens <span style="color: #666666">&gt;</span> chunk_size_tokens:
            chunks<span style="color: #666666">.</span>extend(_split_long_block(block, tokenizer, chunk_size_tokens))
            <span style="color: #008000; font-weight: bold">continue</span>

        current<span style="color: #666666">.</span>append(block)
        token_count <span style="color: #666666">+=</span> block_tokens

    <span style="color: #008000; font-weight: bold">if</span> current:
        chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))

    <span style="color: #008000; font-weight: bold">return</span> chunks
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
