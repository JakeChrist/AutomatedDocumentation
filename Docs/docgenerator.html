<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>docgenerator</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><a href="cache.html">cache</a></li><li><a href="chunk_utils.html">chunk_utils</a></li><li><a href="docgenerator.html">docgenerator</a></li><li><a href="explaincode.html">explaincode</a></li><li><a href="gui_wrapper.html">gui_wrapper</a></li><li><a href="html_writer.html">html_writer</a></li><li><a href="llm_client.html">llm_client</a></li><li><a href="manual_utils.html">manual_utils</a></li><li><a href="parser_cpp.html">parser_cpp</a></li><li><a href="parser_java.html">parser_java</a></li><li><a href="parser_matlab.html">parser_matlab</a></li><li><a href="parser_python.html">parser_python</a></li><li><a href="retrofit_sidebar.html">retrofit_sidebar</a></li><li><a href="reviewer.html">reviewer</a></li><li><a href="sanitize_docs.html">sanitize_docs</a></li><li><a href="scanner.html">scanner</a></li><li><a href="setup.html">setup</a></li><li><a href="summarize_utils.html">summarize_utils</a></li><li><details><summary>tests</summary><ul><li><a href="test_cache.html">test_cache</a></li><li><a href="test_chunk_utils.html">test_chunk_utils</a></li><li><a href="test_docgenerator.html">test_docgenerator</a></li><li><a href="test_docgenerator_subclasses.html">test_docgenerator_subclasses</a></li><li><a href="test_explaincode.html">test_explaincode</a></li><li><a href="test_html_writer.html">test_html_writer</a></li><li><a href="test_integration.html">test_integration</a></li><li><a href="test_llm_client.html">test_llm_client</a></li><li><a href="test_manual_utils.html">test_manual_utils</a></li><li><a href="test_parser_cpp.html">test_parser_cpp</a></li><li><a href="test_parser_java.html">test_parser_java</a></li><li><a href="test_parser_matlab.html">test_parser_matlab</a></li><li><a href="test_parser_python.html">test_parser_python</a></li><li><a href="test_resume_progress.html">test_resume_progress</a></li><li><a href="test_retrofit_sidebar.html">test_retrofit_sidebar</a></li><li><a href="test_reviewer.html">test_reviewer</a></li><li><a href="test_sanitize_docs.html">test_sanitize_docs</a></li><li><a href="test_scanner.html">test_scanner</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>docgenerator</h1>
        <p>This module implements a command-line interface for generating HTML documentation from source code using language model APIs. It processes Python, MATLAB, C++, and Java files by parsing their structural elements, requesting summaries from an LLM client, and writing results to HTML output. The implementation includes functions for cleaning output directories, summarizing code modules with token-based chunking, merging partial summaries, building context-aware prompts for function documentation, rewriting docstrings, and recursively processing functions and class members. It supports caching of LLM responses and handles large code structures by breaking them into manageable chunks while preserving original source structure during processing. The module provides recursive processing of classes, methods, and variables to generate comprehensive summaries and rewrite docstrings, with main functionality that parses source files, builds project summaries, and generates HTML documentation containing navigation and markdown context. It manages caching for both progress tracking and LLM responses, supports resuming or clearing progress, and uses tokenization and chunking techniques to handle large inputs within context limits across multiple programming languages.</p>
<h2>Functions</h2>
<h3 id="clean_output_dir">clean_output_dir(output_dir: str) -&gt; None</h3>
<p>The function `clean_output_dir` removes HTML files from a specified output directory if they were generated by DocGen-LM. It iterates through all files in the directory, checks if a file has a `.html` extension, and reads the first line of the file. If the first line contains the string &quot;Generated by DocGen-LM&quot;, the file is deleted. Any errors encountered while processing a file are caught and reported as warnings, but do not stop the function&#x27;s execution.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clean_output_dir</span>(output_dir: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    <span style="color: #008000; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> os<span style="color: #666666">.</span>listdir(output_dir):
        <span style="color: #008000; font-weight: bold">if</span> filename<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.html&quot;</span>):
            full_path <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(output_dir, filename)
            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(full_path, <span style="color: #BA2121">&quot;r&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>) <span style="color: #008000; font-weight: bold">as</span> f:
                    first_line <span style="color: #666666">=</span> f<span style="color: #666666">.</span>readline()
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;Generated by DocGen-LM&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> first_line:
                        os<span style="color: #666666">.</span>remove(full_path)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
                <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARNING] Could not check </span><span style="color: #A45A77; font-weight: bold">{</span>filename<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>e<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="_summarize">_summarize(client: LLMClient, cache: ResponseCache, key: str, text: str, prompt_type: str) -&gt; str</h3>
<p>The function `_summarize` retrieves or generates a summary for a given text using an LLM client and caches the result. It first checks if a cached response exists for the provided key. If so, it returns the cached summary after sanitizing it to prevent tokenizer errors. If no cached response is found, it generates a new summary using the client&#x27;s `summarize` method with the specified prompt type, stores the result in the cache, and returns the generated summary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize</span>(client: LLMClient, cache: ResponseCache, key: <span style="color: #008000">str</span>, text: <span style="color: #008000">str</span>, prompt_type: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
    cached <span style="color: #666666">=</span> cache<span style="color: #666666">.</span>get(key)
    <span style="color: #008000; font-weight: bold">if</span> cached <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #3D7B7B; font-style: italic"># Cache may contain unsanitized text from earlier runs; clean it to</span>
        <span style="color: #3D7B7B; font-style: italic"># avoid tokenizer errors on reserved tokens.</span>
        <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(cached)
    summary <span style="color: #666666">=</span> client<span style="color: #666666">.</span>summarize(text, prompt_type)
    cache<span style="color: #666666">.</span>set(key, summary)
    <span style="color: #008000; font-weight: bold">return</span> summary
</code></pre>
<h3 id="_chunk_module_by_structure">_chunk_module_by_structure(module: dict, tokenizer, chunk_size_tokens: int)</h3>
<p>The function `_chunk_module_by_structure` takes a parsed module dictionary, a tokenizer, and a maximum chunk size in tokens. It organizes the module&#x27;s content into text chunks that do not exceed the specified token limit. The function processes module-level docstrings, class definitions, methods, variables, and functions, prioritizing structure-based grouping. If individual blocks exceed the token limit, they are further split using a helper function `chunk_text`. The result is a list of text chunks suitable for processing by a language model.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_chunk_module_by_structure</span>(module: <span style="color: #008000">dict</span>, tokenizer, chunk_size_tokens: <span style="color: #008000">int</span>):
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a list of text chunks for ``module`` using its parsed structure.&quot;&quot;&quot;</span>

    blocks <span style="color: #666666">=</span> []
    module_doc <span style="color: #666666">=</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;module_docstring&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> module_doc:
        blocks<span style="color: #666666">.</span>append(module_doc)

    <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []):
        src <span style="color: #666666">=</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(src)) <span style="color: #666666">&lt;=</span> chunk_size_tokens:
            blocks<span style="color: #666666">.</span>append(src)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
                m_src <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
                blocks<span style="color: #666666">.</span>append(m_src)
            <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []):
                v_src <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))
                blocks<span style="color: #666666">.</span>append(v_src)

    <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []):
        blocks<span style="color: #666666">.</span>append(func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)))

    chunks <span style="color: #666666">=</span> []
    current: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    sep_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span>))

    <span style="color: #008000; font-weight: bold">for</span> block <span style="color: #AA22FF; font-weight: bold">in</span> blocks:
        block_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(block))
        <span style="color: #008000; font-weight: bold">if</span> block_tokens <span style="color: #666666">&gt;</span> chunk_size_tokens:
            <span style="color: #008000; font-weight: bold">if</span> current:
                chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))
                current <span style="color: #666666">=</span> []
                current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
            chunks<span style="color: #666666">.</span>extend(chunk_text(block, tokenizer, chunk_size_tokens))
            <span style="color: #008000; font-weight: bold">continue</span>

        additional <span style="color: #666666">=</span> block_tokens <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> current <span style="color: #008000; font-weight: bold">else</span> block_tokens <span style="color: #666666">+</span> sep_tokens
        <span style="color: #008000; font-weight: bold">if</span> current_tokens <span style="color: #666666">+</span> additional <span style="color: #666666">&lt;=</span> chunk_size_tokens:
            current<span style="color: #666666">.</span>append(block)
            current_tokens <span style="color: #666666">+=</span> additional
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">if</span> current:
                chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))
            current <span style="color: #666666">=</span> [block]
            current_tokens <span style="color: #666666">=</span> block_tokens

    <span style="color: #008000; font-weight: bold">if</span> current:
        chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))

    <span style="color: #008000; font-weight: bold">return</span> chunks
</code></pre>
<h3 id="_summarize_module_chunked">_summarize_module_chunked(client: LLMClient, cache: ResponseCache, key_prefix: str, module_text: str, module: dict, tokenizer, max_context_tokens: int, chunk_token_budget: int) -&gt; str</h3>
<p>The function `_summarize_module_chunked` summarizes a module by using structure-aware chunking to manage token limits for LLM processing. It first checks if the entire module text fits within the available token budget; if so, it summarizes directly. Otherwise, it splits the module into structured chunks based on its hierarchy, processes each chunk, and then merges the partial summaries into a final summary. If structure-based chunking fails, it falls back to summarizing the full module text. The merging process recursively combines summaries while respecting token limits, and in case of failures during merging, it returns a sanitized concatenation of partial summaries. The function uses a tokenizer to estimate token counts and integrates with an LLM client and response cache for efficient processing.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_module_chunked</span>(
    client: LLMClient,
    cache: ResponseCache,
    key_prefix: <span style="color: #008000">str</span>,
    module_text: <span style="color: #008000">str</span>,
    module: <span style="color: #008000">dict</span>,
    tokenizer,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize a module using structure-aware chunking.&quot;&quot;&quot;</span>

    template <span style="color: #666666">=</span> PROMPT_TEMPLATES[<span style="color: #BA2121">&quot;module&quot;</span>]
    overhead_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(SYSTEM_PROMPT)) <span style="color: #666666">+</span> <span style="color: #008000">len</span>(
        tokenizer<span style="color: #666666">.</span>encode(template<span style="color: #666666">.</span>format(text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;&quot;</span>))
    )
    available_tokens <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #666666">1</span>, max_context_tokens <span style="color: #666666">-</span> overhead_tokens)

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(module_text)) <span style="color: #666666">&lt;=</span> available_tokens:
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(key_prefix, module_text)
        <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, module_text, <span style="color: #BA2121">&quot;module&quot;</span>)

    chunk_size_tokens <span style="color: #666666">=</span> <span style="color: #008000">min</span>(chunk_token_budget, available_tokens, MAX_CHUNK_TOKENS)
    <span style="color: #008000; font-weight: bold">try</span>:
        parts <span style="color: #666666">=</span> _chunk_module_by_structure(module, tokenizer, chunk_size_tokens)
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARN] Structure-based chunking failed: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(key_prefix, module_text)
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, module_text, <span style="color: #BA2121">&quot;module&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
            <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(<span style="color: #BA2121">&quot;&quot;</span>)

    partials <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> idx, part <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(
        tqdm(parts, desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Summarizing chunks&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
    ):
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:part</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, part)
        <span style="color: #008000; font-weight: bold">try</span>:
            partials<span style="color: #666666">.</span>append(_summarize(client, cache, key, part, <span style="color: #BA2121">&quot;module&quot;</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - network failure</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARN] Summarization failed for chunk </span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> partials:
        <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(<span style="color: #BA2121">&quot;&quot;</span>)

    instructions <span style="color: #666666">=</span> (
        <span style="color: #BA2121">&quot;You are a documentation generator.</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Combine the following summaries into a single technical paragraph.</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Do not critique, evaluate, or offer suggestions.</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Do not speculate or use uncertain language.</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Only summarize what the code explicitly defines.</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span>
    )
    instr_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(instructions))
    merge_budget <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #666666">1</span>, available_tokens <span style="color: #666666">-</span> instr_tokens)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_merge_recursive</span>(items: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], depth: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">0</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        merge_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items)
        prompt <span style="color: #666666">=</span> instructions <span style="color: #666666">+</span> merge_text
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(prompt)) <span style="color: #666666">&lt;=</span> available_tokens:
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
            <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(items) <span style="color: #666666">==</span> <span style="color: #666666">1</span>:
            single <span style="color: #666666">=</span> items[<span style="color: #666666">0</span>]
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:solo&quot;</span>, single)
            <span style="color: #008000; font-weight: bold">return</span> _summarize_chunked(
                client,
                cache,
                key,
                single,
                <span style="color: #BA2121">&quot;docstring&quot;</span>,
                max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
                chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
            )
        groups: <span style="color: #008000">list</span>[<span style="color: #008000">list</span>[<span style="color: #008000">str</span>]] <span style="color: #666666">=</span> []
        current: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items:
            bullet <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
            b_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(bullet))
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">and</span> current_tokens <span style="color: #666666">+</span> b_tokens <span style="color: #666666">&gt;</span> merge_budget:
                groups<span style="color: #666666">.</span>append(current)
                current <span style="color: #666666">=</span> [p]
                current_tokens <span style="color: #666666">=</span> b_tokens
            <span style="color: #008000; font-weight: bold">else</span>:
                current<span style="color: #666666">.</span>append(p)
                current_tokens <span style="color: #666666">+=</span> b_tokens
        <span style="color: #008000; font-weight: bold">if</span> current:
            groups<span style="color: #666666">.</span>append(current)

        merged: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> idx, grp <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(groups):
            merged<span style="color: #666666">.</span>append(_merge_recursive(grp, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>))
        <span style="color: #008000; font-weight: bold">return</span> _merge_recursive(merged, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>)

    <span style="color: #008000; font-weight: bold">try</span>:
        final_summary <span style="color: #666666">=</span> _merge_recursive(partials)
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - network failure</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARN] Merge failed: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(partials))
    <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(final_summary)
</code></pre>
<details>
<summary>Subfunction: _merge_recursive(items: list[str], depth: int=0) -&gt; str</summary>
<h4 id="_merge_recursive">_merge_recursive(items: list[str], depth: int=0) -&gt; str</h4>
<p>The function `_merge_recursive` is a recursive helper function designed to merge a list of string items into a single summarized output. It constructs prompts by joining the input strings with bullet points and evaluates whether the combined prompt fits within the token limit defined by `available_tokens`. If the prompt exceeds the limit, it splits the items into groups that fit within the token budget and recursively processes each group. When a single item remains, it processes that item using a chunked summarization approach. The function supports hierarchical merging of items to manage large inputs while respecting token constraints imposed by the language model. It uses caching keys based on depth and operation type to ensure consistent processing and avoid redundant computations.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_merge_recursive</span>(items: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], depth: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">0</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        merge_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items)
        prompt <span style="color: #666666">=</span> instructions <span style="color: #666666">+</span> merge_text
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(prompt)) <span style="color: #666666">&lt;=</span> available_tokens:
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
            <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(items) <span style="color: #666666">==</span> <span style="color: #666666">1</span>:
            single <span style="color: #666666">=</span> items[<span style="color: #666666">0</span>]
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:solo&quot;</span>, single)
            <span style="color: #008000; font-weight: bold">return</span> _summarize_chunked(
                client,
                cache,
                key,
                single,
                <span style="color: #BA2121">&quot;docstring&quot;</span>,
                max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
                chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
            )
        groups: <span style="color: #008000">list</span>[<span style="color: #008000">list</span>[<span style="color: #008000">str</span>]] <span style="color: #666666">=</span> []
        current: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items:
            bullet <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
            b_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(bullet))
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">and</span> current_tokens <span style="color: #666666">+</span> b_tokens <span style="color: #666666">&gt;</span> merge_budget:
                groups<span style="color: #666666">.</span>append(current)
                current <span style="color: #666666">=</span> [p]
                current_tokens <span style="color: #666666">=</span> b_tokens
            <span style="color: #008000; font-weight: bold">else</span>:
                current<span style="color: #666666">.</span>append(p)
                current_tokens <span style="color: #666666">+=</span> b_tokens
        <span style="color: #008000; font-weight: bold">if</span> current:
            groups<span style="color: #666666">.</span>append(current)

        merged: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> idx, grp <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(groups):
            merged<span style="color: #666666">.</span>append(_merge_recursive(grp, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>))
        <span style="color: #008000; font-weight: bold">return</span> _merge_recursive(merged, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>)
</code></pre>
</details>
<h3 id="_build_function_prompt">_build_function_prompt(source: str, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None) -&gt; str</h3>
<p>The function `_build_function_prompt` generates a context-enriched prompt for summarizing a given function&#x27;s source code. It accepts the function&#x27;s source code and optional class and project context details, then constructs a structured prompt string that includes instructions for the documentation generator and the source code enclosed in a code block. The prompt is formatted to guide the summarization process by providing relevant contextual information such as the containing class and project summary, while ensuring the output adheres to specific formatting constraints.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_function_prompt</span>(
    source: <span style="color: #008000">str</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a context-enriched prompt for summarizing ``source``.&quot;&quot;&quot;</span>

    lines <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;You are a documentation generator.&quot;</span>]
    <span style="color: #008000; font-weight: bold">if</span> class_name:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;The following function is part of the class `</span><span style="color: #A45A77; font-weight: bold">{</span>class_name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">`.&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> class_summary:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;This class </span><span style="color: #A45A77; font-weight: bold">{</span>class_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> project_summary:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;This project </span><span style="color: #A45A77; font-weight: bold">{</span>project_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    lines<span style="color: #666666">.</span>extend(
        [
            <span style="color: #BA2121">&quot;Summarize the function based on its source code below.&quot;</span>,
            <span style="color: #BA2121">&quot;- Do not include assistant phrasing or usage instructions.&quot;</span>,
            <span style="color: #BA2121">&quot;- Do not mention unrelated games or systems.&quot;</span>,
            <span style="color: #BA2121">&quot;- Only use the context and code provided.&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">&quot;```python&quot;</span>,
            source,
            <span style="color: #BA2121">&quot;```&quot;</span>,
        ]
    )
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(lines)
</code></pre>
<h3 id="_rewrite_docstring">_rewrite_docstring(client: LLMClient, cache: ResponseCache, file_path: str, item: dict[str, str], *, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None, tokenizer=None, max_context_tokens: int=4096, chunk_token_budget: int=3072) -&gt; None</h3>
<p>The function `_rewrite_docstring` updates the docstring of a given code item by generating a new docstring using a language model. It accepts an LLM client, cache, file path, and item dictionary containing source code and current docstring. Optional context such as class name, class summary, and project summary can be provided to enhance the docstring generation.

If no source or docstring is present, it issues a warning and exits. If no docstring exists, it returns early without modification. When context is provided, it constructs a prompt using `_build_function_prompt` and computes a cache key based on the item&#x27;s content and context. Otherwise, it uses a default prompt format.

The function then calls `_summarize_chunked` to process the prompt with the LLM, leveraging caching to avoid redundant computations. The resulting summary replaces the original docstring in the item dictionary. If no valid summary is returned, it defaults to &quot;No summary available.&quot;</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_rewrite_docstring</span>(
    client: LLMClient,
    cache: ResponseCache,
    file_path: <span style="color: #008000">str</span>,
    item: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">str</span>],
    <span style="color: #666666">*</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    tokenizer<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
    max_context_tokens: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">4096</span>,
    chunk_token_budget: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">3072</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Rewrite ``item`` docstring using optional context.&quot;&quot;&quot;</span>

    source <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
    docstring <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> source <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> docstring:
        <span style="color: #008000">print</span>(
            <span style="color: #BA2121">f&quot;Warning: no source or docstring for </span><span style="color: #A45A77; font-weight: bold">{</span>file_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
        )
        <span style="color: #008000; font-weight: bold">return</span>

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> docstring:
        <span style="color: #008000; font-weight: bold">return</span>

    <span style="color: #008000; font-weight: bold">if</span> class_name <span style="color: #AA22FF; font-weight: bold">or</span> class_summary <span style="color: #AA22FF; font-weight: bold">or</span> project_summary:
        prompt <span style="color: #666666">=</span> _build_function_prompt(
            source,
            class_name<span style="color: #666666">=</span>class_name,
            class_summary<span style="color: #666666">=</span>class_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
        )
        key_content <span style="color: #666666">=</span> source <span style="color: #666666">+</span> (class_name <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> (class_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> (project_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        prompt <span style="color: #666666">=</span> DOC_PROMPT<span style="color: #666666">.</span>format(source<span style="color: #666666">=</span>source, docstring<span style="color: #666666">=</span>docstring)
        key_content <span style="color: #666666">=</span> source <span style="color: #666666">+</span> docstring

    key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
        <span style="color: #BA2121">f&quot;REWRITE:</span><span style="color: #A45A77; font-weight: bold">{</span>file_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
        key_content,
    )
    result <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        key,
        prompt,
        <span style="color: #BA2121">&quot;docstring&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    item[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> sanitize_summary(result) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;No summary available.&quot;</span>
</code></pre>
<h3 id="_summarize_function_recursive">_summarize_function_recursive(func: dict[str, Any], path: str, client: LLMClient, cache: ResponseCache, tokenizer, max_context_tokens: int, chunk_token_budget: int, *, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None, rewrite: bool=True) -&gt; None</h3>
<p>The function `_summarize_function_recursive` recursively summarizes a given function and its nested subfunctions and subclasses. It constructs a prompt using the function&#x27;s source code or signature, retrieves or generates a summary via a language model client, and stores the result in the function dictionary. If enabled, it also rewrites the function&#x27;s docstring. The function processes subfunctions by recursively calling itself and handles subclasses by invoking `_summarize_class_recursive`. It utilizes caching and token budgeting to manage large inputs and ensure efficient processing.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_function_recursive</span>(
    func: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
    path: <span style="color: #008000">str</span>,
    client: LLMClient,
    cache: ResponseCache,
    tokenizer,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
    <span style="color: #666666">*</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    rewrite: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize ``func`` and recursively process its subfunctions and subclasses.&quot;&quot;&quot;</span>

    src <span style="color: #666666">=</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
    prompt <span style="color: #666666">=</span> _build_function_prompt(
        src,
        class_name<span style="color: #666666">=</span>class_name,
        class_summary<span style="color: #666666">=</span>class_summary,
        project_summary<span style="color: #666666">=</span>project_summary,
    )
    key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
    summary <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        key,
        prompt,
        <span style="color: #BA2121">&quot;docstring&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    func[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> summary
    <span style="color: #008000; font-weight: bold">if</span> rewrite:
        _rewrite_docstring(
            client,
            cache,
            path,
            func,
            class_name<span style="color: #666666">=</span>class_name,
            class_summary<span style="color: #666666">=</span>class_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> sub <span style="color: #AA22FF; font-weight: bold">in</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;subfunctions&quot;</span>, []):
        _summarize_function_recursive(
            sub,
            path,
            client,
            cache,
            tokenizer,
            max_context_tokens,
            chunk_token_budget,
            class_name<span style="color: #666666">=</span>class_name,
            class_summary<span style="color: #666666">=</span>class_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
        )

    <span style="color: #008000; font-weight: bold">for</span> subcls <span style="color: #AA22FF; font-weight: bold">in</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;subclasses&quot;</span>, []):
        _summarize_class_recursive(
            subcls,
            path,
            project_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>,
            tokenizer,
            client,
            cache,
            max_context_tokens,
            chunk_token_budget,
        )
</code></pre>
<h3 id="_summarize_members_recursive">_summarize_members_recursive(class_data: dict[str, Any], path: str, client: LLMClient, cache: ResponseCache, tokenizer, max_context_tokens: int, chunk_token_budget: int, project_summary: str | None=None) -&gt; None</h3>
<p>The function `_summarize_members_recursive` recursively summarizes the methods and variables of a given class and its subclasses. For each method, it retrieves or constructs source code, generates a summary using a chunked summarization approach, and assigns the summary as both the &quot;summary&quot; and &quot;docstring&quot; fields. It then performs further recursive summarization on the method&#x27;s contents. Similarly, for each variable, it generates a summary and assigns it to the &quot;summary&quot; and &quot;docstring&quot; fields. The function also recursively processes any subclasses of the current class, applying the same summarization logic. The summarization uses an LLM client, a response cache, and token budgeting to manage context length.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_members_recursive</span>(
    class_data: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
    path: <span style="color: #008000">str</span>,
    client: LLMClient,
    cache: ResponseCache,
    tokenizer,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize methods and variables of ``class_data`` and any subclasses.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;methods&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
        src <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
            <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, src
        )
        summary <span style="color: #666666">=</span> _summarize_chunked(
            client,
            cache,
            key,
            src,
            <span style="color: #BA2121">&quot;function&quot;</span>,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )
        method[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> summary
        method[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> summary
        _summarize_function_recursive(
            method,
            path,
            client,
            cache,
            tokenizer,
            max_context_tokens,
            chunk_token_budget,
            class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>),
            project_summary<span style="color: #666666">=</span>project_summary,
            rewrite<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>,
        )

    <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;variables&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
        src <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
            <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, src
        )
        summary <span style="color: #666666">=</span> _summarize_chunked(
            client,
            cache,
            key,
            src,
            <span style="color: #BA2121">&quot;function&quot;</span>,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )
        var[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> summary
        var[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> summary

    <span style="color: #008000; font-weight: bold">for</span> sub <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;subclasses&quot;</span>, []):
        _summarize_members_recursive(
            sub,
            path,
            client,
            cache,
            tokenizer,
            max_context_tokens,
            chunk_token_budget,
            project_summary,
        )
</code></pre>
<h3 id="_summarize_class_recursive">_summarize_class_recursive(class_data: dict[str, Any], path: str, project_summary: str, tokenizer, client: LLMClient, cache: ResponseCache, max_context_tokens: int, chunk_token_budget: int) -&gt; None</h3>
<p>The function `_summarize_class_recursive` recursively summarizes a class by processing its members, methods, and variables, and then generates and updates docstrings for the class and its components. It first processes all members of the class using `_summarize_members_recursive`. It constructs formatted text for methods and variables, then creates a prompt using `CLASS_PROMPT` to generate a class summary via `_summarize_chunked`. The generated summary is sanitized and used to update the class&#x27;s docstring. If an original docstring exists, it is preserved and used in `_rewrite_docstring` to refine the class&#x27;s documentation. The function then applies `_rewrite_docstring` to each method and variable within the class. Finally, it recursively calls itself for any subclasses present in the class data.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_class_recursive</span>(
    class_data: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
    path: <span style="color: #008000">str</span>,
    project_summary: <span style="color: #008000">str</span>,
    tokenizer,
    client: LLMClient,
    cache: ResponseCache,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize ``class_data`` and rewrite its docstring and methods.&quot;&quot;&quot;</span>

    _summarize_members_recursive(
        class_data,
        path,
        client,
        cache,
        tokenizer,
        max_context_tokens,
        chunk_token_budget,
        project_summary,
    )

    method_lines <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
        summary <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        name <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        method_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">if</span> summary <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    methods_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(method_lines) <span style="color: #008000; font-weight: bold">if</span> method_lines <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;- (no methods)&quot;</span>

    var_lines <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []):
        summary <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))
        name <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        var_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">if</span> summary <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    variables_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(var_lines) <span style="color: #008000; font-weight: bold">if</span> var_lines <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;- (no variables)&quot;</span>

    class_prompt <span style="color: #666666">=</span> CLASS_PROMPT<span style="color: #666666">.</span>format(
        class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>),
        project_summary<span style="color: #666666">=</span>project_summary,
        methods<span style="color: #666666">=</span>methods_text,
        variables<span style="color: #666666">=</span>variables_text,
    )
    cls_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, class_prompt)
    cls_summary <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        cls_key,
        class_prompt,
        <span style="color: #BA2121">&quot;docstring&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    cls_summary <span style="color: #666666">=</span> sanitize_summary(cls_summary)
    original_doc <span style="color: #666666">=</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
    class_data[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> cls_summary
    class_data[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> cls_summary
    <span style="color: #008000; font-weight: bold">if</span> original_doc:
        class_data[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> original_doc
        _rewrite_docstring(
            client,
            cache,
            path,
            class_data,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
        _rewrite_docstring(
            client,
            cache,
            path,
            method,
            class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>),
            class_summary<span style="color: #666666">=</span>cls_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []):
        _rewrite_docstring(
            client,
            cache,
            path,
            var,
            class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>),
            class_summary<span style="color: #666666">=</span>cls_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> sub <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;subclasses&quot;</span>, []):
        _summarize_class_recursive(
            sub,
            path,
            project_summary,
            tokenizer,
            client,
            cache,
            max_context_tokens,
            chunk_token_budget,
        )
</code></pre>
<h3 id="main">main(argv: list[str] | None=None) -&gt; int</h3>
<p>The `main` function serves as the primary entry point for generating HTML documentation from source code using a local language model. It accepts command-line arguments to configure the source directory, output location, LLM API endpoint, token limits, and other processing options. The function initializes an LLM client, validates connectivity, and sets up tokenization and chunking parameters based on context limits.

It scans the source directory for supported files (Python, C++, Java, MATLAB), parses them into structured data, and summarizes modules using chunked LLM requests. The function maintains progress tracking via a cache to support resumable runs and clears progress upon successful completion if specified.

For each module, it processes classes and functions recursively to generate detailed summaries, integrating project-level context for enhanced accuracy. Markdown files from documentation directories are also included in the project summary. After all processing is complete, the function writes an index page and individual module pages to the output directory, updating the progress cache accordingly. The function returns an integer exit code indicating success or failure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(argv: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser(description<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Generate HTML documentation using a local LLM&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&quot;source&quot;</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Path to the source directory&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&quot;--output&quot;</span>, required<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Destination directory for HTML output&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--ignore&quot;</span>,
        action<span style="color: #666666">=</span><span style="color: #BA2121">&quot;append&quot;</span>,
        default<span style="color: #666666">=</span>[],
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Paths relative to source that should be ignored (repeatable)&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--llm-url&quot;</span>,
        default<span style="color: #666666">=</span><span style="color: #BA2121">&quot;http://localhost:1234&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Base URL of the LLM API&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--model&quot;</span>,
        default<span style="color: #666666">=</span><span style="color: #BA2121">&quot;local&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Model name to use when contacting the LLM&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--max-context-tokens&quot;</span>,
        <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">int</span>,
        default<span style="color: #666666">=4096</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Maximum token context window for the LLM&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--chunk-token-budget&quot;</span>,
        <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">int</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Maximum tokens per chunk (defaults to 75</span><span style="color: #A45A77; font-weight: bold">% o</span><span style="color: #BA2121">f context)&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--resume&quot;</span>,
        action<span style="color: #666666">=</span><span style="color: #BA2121">&quot;store_true&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Resume from previously saved progress&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--clear-progress&quot;</span>,
        action<span style="color: #666666">=</span><span style="color: #BA2121">&quot;store_true&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Clear saved progress after a successful run&quot;</span>,
    )
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args(argv)

    client <span style="color: #666666">=</span> LLMClient(base_url<span style="color: #666666">=</span>args<span style="color: #666666">.</span>llm_url, model<span style="color: #666666">=</span>args<span style="color: #666666">.</span>model)
    <span style="color: #008000; font-weight: bold">try</span>:
        client<span style="color: #666666">.</span>ping()
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ConnectionError</span> <span style="color: #008000; font-weight: bold">as</span> exc:
        <span style="color: #008000">print</span>(<span style="color: #008000">str</span>(exc), file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1</span>

    tokenizer <span style="color: #666666">=</span> get_tokenizer()
    max_context_tokens <span style="color: #666666">=</span> args<span style="color: #666666">.</span>max_context_tokens
    <span style="color: #008000; font-weight: bold">if</span> max_context_tokens <span style="color: #666666">&gt;</span> MAX_CHUNK_TOKENS:
        <span style="color: #008000">print</span>(
            (
                <span style="color: #BA2121">f&quot;[WARN] --max-context-tokens </span><span style="color: #A45A77; font-weight: bold">{</span>max_context_tokens<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> exceeds &quot;</span>
                <span style="color: #BA2121">f&quot;cap of </span><span style="color: #A45A77; font-weight: bold">{</span>MAX_CHUNK_TOKENS<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">; extra context is ignored&quot;</span>
            ),
            file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
        )
    max_context_tokens <span style="color: #666666">=</span> <span style="color: #008000">min</span>(max_context_tokens, MAX_CHUNK_TOKENS)
    default_chunk_budget <span style="color: #666666">=</span> <span style="color: #008000">int</span>(max_context_tokens <span style="color: #666666">*</span> <span style="color: #666666">0.75</span>)
    <span style="color: #008000; font-weight: bold">if</span> args<span style="color: #666666">.</span>chunk_token_budget <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
        chunk_token_budget <span style="color: #666666">=</span> <span style="color: #008000">min</span>(args<span style="color: #666666">.</span>chunk_token_budget, default_chunk_budget)
    <span style="color: #008000; font-weight: bold">else</span>:
        chunk_token_budget <span style="color: #666666">=</span> default_chunk_budget
    chunk_token_budget <span style="color: #666666">=</span> <span style="color: #008000">min</span>(chunk_token_budget, MAX_CHUNK_TOKENS)

    output_dir <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>output)
    output_dir<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    clean_output_dir(<span style="color: #008000">str</span>(output_dir))
    static_dir <span style="color: #666666">=</span> Path(<span style="color: #19177C">__file__</span>)<span style="color: #666666">.</span>parent <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;static&quot;</span>
    <span style="color: #3D7B7B; font-style: italic"># use absolute path so execution works from any current working directory</span>
    shutil<span style="color: #666666">.</span>copytree(static_dir, output_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;static&quot;</span>, dirs_exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)

    cache <span style="color: #666666">=</span> ResponseCache(<span style="color: #008000">str</span>(output_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;cache.json&quot;</span>))
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> args<span style="color: #666666">.</span>resume:
        cache<span style="color: #666666">.</span>clear_progress()
    progress <span style="color: #666666">=</span> cache<span style="color: #666666">.</span>get_progress()
    processed_paths <span style="color: #666666">=</span> <span style="color: #008000">set</span>(progress<span style="color: #666666">.</span>keys())

    source_root <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>source)<span style="color: #666666">.</span>resolve()
    files <span style="color: #666666">=</span> scan_directory(args<span style="color: #666666">.</span>source, args<span style="color: #666666">.</span>ignore)
    modules <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(files, desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Processing modules&quot;</span>):
        <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #AA22FF; font-weight: bold">in</span> processed_paths:
            modules<span style="color: #666666">.</span>append(progress[path])
            <span style="color: #008000; font-weight: bold">continue</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            text <span style="color: #666666">=</span> Path(path)<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">UnicodeDecodeError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># skip files with invalid encoding</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">if</span> path<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.py&quot;</span>):
                parsed <span style="color: #666666">=</span> parse_python_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;python&quot;</span>
            <span style="color: #008000; font-weight: bold">elif</span> path<span style="color: #666666">.</span>endswith((<span style="color: #BA2121">&quot;.cpp&quot;</span>, <span style="color: #BA2121">&quot;.h&quot;</span>)):
                parsed <span style="color: #666666">=</span> parse_cpp_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;cpp&quot;</span>
            <span style="color: #008000; font-weight: bold">elif</span> path<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.java&quot;</span>):
                parsed <span style="color: #666666">=</span> parse_java_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;java&quot;</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                parsed <span style="color: #666666">=</span> parse_matlab_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;matlab&quot;</span>
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">SyntaxError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># malformed file should be ignored</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
            <span style="color: #008000; font-weight: bold">continue</span>

        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(path, text)
        summary <span style="color: #666666">=</span> _summarize_module_chunked(
            client,
            cache,
            key,
            text,
            parsed,
            tokenizer,
            max_context_tokens,
            chunk_token_budget,
        )

        module <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;name&quot;</span>: Path(path)<span style="color: #666666">.</span>stem,
            <span style="color: #BA2121">&quot;language&quot;</span>: language,
            <span style="color: #BA2121">&quot;summary&quot;</span>: summary,
            <span style="color: #BA2121">&quot;filename&quot;</span>: Path(path)<span style="color: #666666">.</span>name,
            <span style="color: #BA2121">&quot;path&quot;</span>: path,
            <span style="color: #BA2121">&quot;relpath&quot;</span>: <span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>relative_to(source_root)),
        }
        module<span style="color: #666666">.</span>update(parsed)

        <span style="color: #3D7B7B; font-style: italic"># summarize methods now so class summaries can reference them later</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>module[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: classes&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            _summarize_members_recursive(
                <span style="color: #008000">cls</span>,
                path,
                client,
                cache,
                tokenizer,
                max_context_tokens,
                chunk_token_budget,
                <span style="color: #008000; font-weight: bold">None</span>,
            )

        <span style="color: #3D7B7B; font-style: italic"># and for standalone functions (summarized later with project context)</span>
        <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;methods&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            func[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>

        modules<span style="color: #666666">.</span>append(module)

    nav_tree: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_insert</span>(tree: <span style="color: #008000">dict</span>, parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], name: <span style="color: #008000">str</span>, link: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> parts:
            tree<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;__files__&quot;</span>, [])<span style="color: #666666">.</span>append((name, link))
            <span style="color: #008000; font-weight: bold">return</span>
        head <span style="color: #666666">=</span> parts[<span style="color: #666666">0</span>]
        sub <span style="color: #666666">=</span> tree<span style="color: #666666">.</span>setdefault(head, {})
        _insert(sub, parts[<span style="color: #666666">1</span>:], name, link)

    <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        rel_parts <span style="color: #666666">=</span> <span style="color: #008000">list</span>(Path(m[<span style="color: #BA2121">&quot;relpath&quot;</span>])<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>parts)
        _insert(nav_tree, rel_parts, m[<span style="color: #BA2121">&quot;name&quot;</span>], <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>m[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.html&quot;</span>)

    project_lines <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;Project structure:&quot;</span>]
    <span style="color: #008000; font-weight: bold">for</span> mod <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>mod[<span style="color: #BA2121">&#39;filename&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        classes <span style="color: #666666">=</span> mod<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []) <span style="color: #AA22FF; font-weight: bold">or</span> []
        functions <span style="color: #666666">=</span> mod<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []) <span style="color: #AA22FF; font-weight: bold">or</span> []

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> classes <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> functions:
            <span style="color: #008000">print</span>(
                <span style="color: #BA2121">f&quot;Warning: </span><span style="color: #A45A77; font-weight: bold">{</span>mod[<span style="color: #BA2121">&#39;filename&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> has no classes or functions&quot;</span>,
                file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
            )
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;  - (no classes or functions defined)&quot;</span>)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> classes:
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;  - Class: </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            method_names <span style="color: #666666">=</span> [m<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, [])]
            methods_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(method_names) <span style="color: #008000; font-weight: bold">if</span> method_names <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;(none)&quot;</span>
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;    - Methods: </span><span style="color: #A45A77; font-weight: bold">{</span>methods_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

        <span style="color: #008000; font-weight: bold">if</span> functions:
            func_names <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(f<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> f <span style="color: #AA22FF; font-weight: bold">in</span> functions)
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;  - Functions: </span><span style="color: #A45A77; font-weight: bold">{</span>func_names<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    project_outline <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(project_lines)

    <span style="color: #3D7B7B; font-style: italic"># gather markdown documentation</span>
    md_files: <span style="color: #008000">list</span>[Path] <span style="color: #666666">=</span> []
    readme <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>source) <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;README.md&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> readme<span style="color: #666666">.</span>exists():
        md_files<span style="color: #666666">.</span>append(readme)

    base <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>source)<span style="color: #666666">.</span>resolve()
    ignore_paths <span style="color: #666666">=</span> {(base <span style="color: #666666">/</span> p)<span style="color: #666666">.</span>resolve() <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> args<span style="color: #666666">.</span>ignore}

    <span style="color: #008000; font-weight: bold">for</span> root, dirs, _files <span style="color: #AA22FF; font-weight: bold">in</span> os<span style="color: #666666">.</span>walk(base, topdown<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, followlinks<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
        root_path <span style="color: #666666">=</span> Path(root)

        <span style="color: #3D7B7B; font-style: italic"># prune symlinks and ignored directories</span>
        pruned: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dirs:
            dir_path <span style="color: #666666">=</span> root_path <span style="color: #666666">/</span> d
            <span style="color: #008000; font-weight: bold">if</span> dir_path<span style="color: #666666">.</span>is_symlink():
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">any</span>(_is_subpath((dir_path)<span style="color: #666666">.</span>resolve(), ig) <span style="color: #008000; font-weight: bold">for</span> ig <span style="color: #AA22FF; font-weight: bold">in</span> ignore_paths):
                <span style="color: #008000; font-weight: bold">continue</span>
            pruned<span style="color: #666666">.</span>append(d)
        dirs[:] <span style="color: #666666">=</span> pruned

        docs_dirs <span style="color: #666666">=</span> [d <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dirs <span style="color: #008000; font-weight: bold">if</span> d<span style="color: #666666">.</span>lower() <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;docs&quot;</span>]
        <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> docs_dirs:
            docs_path <span style="color: #666666">=</span> root_path <span style="color: #666666">/</span> d
            <span style="color: #008000; font-weight: bold">for</span> r, d2, f2 <span style="color: #AA22FF; font-weight: bold">in</span> os<span style="color: #666666">.</span>walk(docs_path, topdown<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, followlinks<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
                r_path <span style="color: #666666">=</span> Path(r)
                d2[:] <span style="color: #666666">=</span> [
                    dd
                    <span style="color: #008000; font-weight: bold">for</span> dd <span style="color: #AA22FF; font-weight: bold">in</span> d2
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> (r_path <span style="color: #666666">/</span> dd)<span style="color: #666666">.</span>is_symlink()
                    <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">any</span>(_is_subpath((r_path <span style="color: #666666">/</span> dd)<span style="color: #666666">.</span>resolve(), ig) <span style="color: #008000; font-weight: bold">for</span> ig <span style="color: #AA22FF; font-weight: bold">in</span> ignore_paths)
                ]
                <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> f2:
                    <span style="color: #008000; font-weight: bold">if</span> name<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.md&quot;</span>):
                        md_files<span style="color: #666666">.</span>append(Path(r_path) <span style="color: #666666">/</span> name)

        <span style="color: #3D7B7B; font-style: italic"># prevent os.walk from recursing into docs directories again</span>
        dirs[:] <span style="color: #666666">=</span> [d <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dirs <span style="color: #008000; font-weight: bold">if</span> d<span style="color: #666666">.</span>lower() <span style="color: #666666">!=</span> <span style="color: #BA2121">&quot;docs&quot;</span>]

    md_parts <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> md_file <span style="color: #AA22FF; font-weight: bold">in</span> md_files:
        <span style="color: #008000; font-weight: bold">try</span>:
            md_parts<span style="color: #666666">.</span>append(md_file<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&#39;utf-8&#39;</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - filesystem edge case</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>md_file<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)

    md_context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(md_parts)<span style="color: #666666">.</span>strip()
    readme_summary <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> md_context:
        readme_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">&quot;README&quot;</span>, md_context)
        readme_summary <span style="color: #666666">=</span> _summarize_chunked(
            client,
            cache,
            readme_key,
            md_context,
            <span style="color: #BA2121">&quot;readme&quot;</span>,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )
        readme_summary <span style="color: #666666">=</span> sanitize_summary(readme_summary)

    project_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">&quot;PROJECT&quot;</span>, project_outline)
    raw_summary <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        project_key,
        project_outline,
        <span style="color: #BA2121">&quot;project&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    project_summary <span style="color: #666666">=</span> sanitize_summary(raw_summary)
    <span style="color: #008000; font-weight: bold">if</span> readme_summary:
        project_summary <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>readme_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>project_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>strip()

    <span style="color: #3D7B7B; font-style: italic"># Now that the project summary is available, generate class and function summaries</span>
    <span style="color: #3D7B7B; font-style: italic"># and rewrite method/function docstrings with context.</span>
    <span style="color: #008000; font-weight: bold">for</span> module <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        path <span style="color: #666666">=</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #AA22FF; font-weight: bold">in</span> processed_paths:
            <span style="color: #008000; font-weight: bold">continue</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>module[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: classes&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            _summarize_class_recursive(
                <span style="color: #008000">cls</span>,
                path,
                project_summary,
                tokenizer,
                client,
                cache,
                max_context_tokens,
                chunk_token_budget,
            )
        <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;functions&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            _summarize_function_recursive(
                func,
                path,
                client,
                cache,
                tokenizer,
                max_context_tokens,
                chunk_token_budget,
                project_summary<span style="color: #666666">=</span>project_summary,
            )

    module_summaries <span style="color: #666666">=</span> {m[<span style="color: #BA2121">&quot;name&quot;</span>]: m<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> modules}
    write_index(<span style="color: #008000">str</span>(output_dir), project_summary, nav_tree, module_summaries)
    <span style="color: #008000; font-weight: bold">for</span> module <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        write_module_page(<span style="color: #008000">str</span>(output_dir), module, nav_tree)
        cache<span style="color: #666666">.</span>set_progress_entry(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>), module)
        processed_paths<span style="color: #666666">.</span>add(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))

    <span style="color: #008000; font-weight: bold">if</span> (
        <span style="color: #AA22FF; font-weight: bold">not</span> args<span style="color: #666666">.</span>resume
        <span style="color: #AA22FF; font-weight: bold">or</span> args<span style="color: #666666">.</span>clear_progress
        <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000">len</span>(processed_paths) <span style="color: #666666">==</span> <span style="color: #008000">len</span>(files)
    ):
        cache<span style="color: #666666">.</span>clear_progress()

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0</span>
</code></pre>
<details>
<summary>Subfunction: _insert(tree: dict, parts: list[str], name: str, link: str) -&gt; None</summary>
<h4 id="_insert">_insert(tree: dict, parts: list[str], name: str, link: str) -&gt; None</h4>
<p>The function `_insert` recursively builds a nested dictionary structure to organize items into a tree-like hierarchy based on a list of path components. It takes a dictionary `tree`, a list of strings `parts` representing path segments, a string `name` for the item being inserted, and a string `link` associated with the item. If the `parts` list is empty, it appends a tuple of `(name, link)` to the `&quot;__files__&quot;` key in the current tree node. Otherwise, it processes the first segment in `parts`, creates or retrieves a subtree for that segment, and recursively inserts the remaining segments into the subtree. This enables hierarchical organization of items such as files or documentation entries within a structured navigation system.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_insert</span>(tree: <span style="color: #008000">dict</span>, parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], name: <span style="color: #008000">str</span>, link: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> parts:
            tree<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;__files__&quot;</span>, [])<span style="color: #666666">.</span>append((name, link))
            <span style="color: #008000; font-weight: bold">return</span>
        head <span style="color: #666666">=</span> parts[<span style="color: #666666">0</span>]
        sub <span style="color: #666666">=</span> tree<span style="color: #666666">.</span>setdefault(head, {})
        _insert(sub, parts[<span style="color: #666666">1</span>:], name, link)
</code></pre>
</details>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
