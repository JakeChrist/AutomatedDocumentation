<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>docgenerator</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul>
        <li><a href="index.html"><strong>üè† Project Overview</strong></a></li>
<li><a href="cache.html">cache</a></li>
<li><a href="chunk_utils.html">chunk_utils</a></li>
<li><a href="docgenerator.html">docgenerator</a></li>
<li><a href="explaincode.html">explaincode</a></li>
<li><a href="gui_wrapper.html">gui_wrapper</a></li>
<li><a href="html_writer.html">html_writer</a></li>
<li><a href="llm_client.html">llm_client</a></li>
<li><a href="manual_utils.html">manual_utils</a></li>
<li><a href="parser_cpp.html">parser_cpp</a></li>
<li><a href="parser_java.html">parser_java</a></li>
<li><a href="parser_matlab.html">parser_matlab</a></li>
<li><a href="parser_python.html">parser_python</a></li>
<li><a href="reviewer.html">reviewer</a></li>
<li><a href="scanner.html">scanner</a></li>
<li><a href="setup.html">setup</a></li>
<li><a href="summarize_utils.html">summarize_utils</a></li>
<li><a href="test_cache.html">test_cache</a></li>
<li><a href="test_chunk_utils.html">test_chunk_utils</a></li>
<li><a href="test_docgenerator.html">test_docgenerator</a></li>
<li><a href="test_docgenerator_subclasses.html">test_docgenerator_subclasses</a></li>
<li><a href="test_explaincode.html">test_explaincode</a></li>
<li><a href="test_html_writer.html">test_html_writer</a></li>
<li><a href="test_integration.html">test_integration</a></li>
<li><a href="test_llm_client.html">test_llm_client</a></li>
<li><a href="test_manual_utils.html">test_manual_utils</a></li>
<li><a href="test_parser_cpp.html">test_parser_cpp</a></li>
<li><a href="test_parser_java.html">test_parser_java</a></li>
<li><a href="test_parser_matlab.html">test_parser_matlab</a></li>
<li><a href="test_parser_python.html">test_parser_python</a></li>
<li><a href="test_reviewer.html">test_reviewer</a></li>
<li><a href="test_scanner.html">test_scanner</a></li>
        </ul>
    </div>
    <div class="content">
        <h1>docgenerator</h1>
        <p>This module provides a command-line interface for generating HTML documentation using DocGen-LM. It scans a source tree for Python, MATLAB, C++, and Java files, parses them, requests summaries from a running LLM, and writes the documentation. The module includes functions for cleaning output directories, summarizing text with caching, chunking modules by structure, summarizing modules in a structured manner, building context-enriched prompts, rewriting docstrings, and recursively summarizing members of classes and their subclasses. It defines a Python script that processes directories, ignores specified paths, handles file encoding errors, and uses command-line arguments for configuration, such as the source directory, output directory, ignored paths, LLM URL, model name, and token budget. The script reads files, parses them into structured data, generates summaries using the LLM, and writes HTML documentation pages.</p>
<h2>Functions</h2>
<h3 id="clean_output_dir">clean_output_dir(output_dir: str) -&gt; None</h3>
<p>The function `clean_output_dir` takes a directory path (`output_dir`) as input and iterates through all files in that directory. If a file is an HTML file (ends with &quot;.html&quot;), it reads the first line of the file. If the first line contains &quot;Generated by DocGen-LM&quot;, the file is deleted. Any exceptions during file operations are caught, and a warning message is printed indicating which file could not be checked or removed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clean_output_dir</span>(output_dir: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    <span style="color: #008000; font-weight: bold">for</span> filename <span style="color: #AA22FF; font-weight: bold">in</span> os<span style="color: #666666">.</span>listdir(output_dir):
        <span style="color: #008000; font-weight: bold">if</span> filename<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.html&quot;</span>):
            full_path <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(output_dir, filename)
            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(full_path, <span style="color: #BA2121">&quot;r&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>) <span style="color: #008000; font-weight: bold">as</span> f:
                    first_line <span style="color: #666666">=</span> f<span style="color: #666666">.</span>readline()
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;Generated by DocGen-LM&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> first_line:
                        os<span style="color: #666666">.</span>remove(full_path)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
                <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARNING] Could not check </span><span style="color: #A45A77; font-weight: bold">{</span>filename<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>e<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="_summarize">_summarize(client: LLMClient, cache: ResponseCache, key: str, text: str, prompt_type: str) -&gt; str</h3>
<p>The `_summarize` function takes an `LLMClient`, a `ResponseCache`, a `key`, a `text`, and a `prompt_type`. It first checks if the summary for the given key is already cached. If it is, it returns the cached summary. Otherwise, it uses the LLM client to generate a summary of the provided text based on the prompt type. The generated summary is then stored in the cache under the specified key and returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize</span>(client: LLMClient, cache: ResponseCache, key: <span style="color: #008000">str</span>, text: <span style="color: #008000">str</span>, prompt_type: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
    cached <span style="color: #666666">=</span> cache<span style="color: #666666">.</span>get(key)
    <span style="color: #008000; font-weight: bold">if</span> cached <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">return</span> cached
    summary <span style="color: #666666">=</span> client<span style="color: #666666">.</span>summarize(text, prompt_type)
    cache<span style="color: #666666">.</span>set(key, summary)
    <span style="color: #008000; font-weight: bold">return</span> summary
</code></pre>
<h3 id="_chunk_module_by_structure">_chunk_module_by_structure(module: dict, tokenizer, chunk_size_tokens: int)</h3>
<p>This function `_chunk_module_by_structure` takes a dictionary representing a module, a tokenizer object, and an integer `chunk_size_tokens`. It processes the module&#x27;s structure to create text chunks that do not exceed the specified token size. The function first extracts the module documentation if available. Then, it iterates through classes, methods, variables, and functions within the module, adding their source code to blocks. If a block exceeds the token limit, it is further chunked using another function `chunk_text`. Finally, it combines these blocks into chunks that fit within the token size limit, ensuring that each chunk is separated by two newline characters for readability.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_chunk_module_by_structure</span>(module: <span style="color: #008000">dict</span>, tokenizer, chunk_size_tokens: <span style="color: #008000">int</span>):
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a list of text chunks for ``module`` using its parsed structure.&quot;&quot;&quot;</span>

    blocks <span style="color: #666666">=</span> []
    module_doc <span style="color: #666666">=</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;module_docstring&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> module_doc:
        blocks<span style="color: #666666">.</span>append(module_doc)

    <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []):
        src <span style="color: #666666">=</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(src)) <span style="color: #666666">&lt;=</span> chunk_size_tokens:
            blocks<span style="color: #666666">.</span>append(src)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
                m_src <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
                blocks<span style="color: #666666">.</span>append(m_src)
            <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []):
                v_src <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))
                blocks<span style="color: #666666">.</span>append(v_src)

    <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []):
        blocks<span style="color: #666666">.</span>append(func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)))

    chunks <span style="color: #666666">=</span> []
    current: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    sep_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span>))

    <span style="color: #008000; font-weight: bold">for</span> block <span style="color: #AA22FF; font-weight: bold">in</span> blocks:
        block_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(block))
        <span style="color: #008000; font-weight: bold">if</span> block_tokens <span style="color: #666666">&gt;</span> chunk_size_tokens:
            <span style="color: #008000; font-weight: bold">if</span> current:
                chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))
                current <span style="color: #666666">=</span> []
                current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
            chunks<span style="color: #666666">.</span>extend(chunk_text(block, tokenizer, chunk_size_tokens))
            <span style="color: #008000; font-weight: bold">continue</span>

        additional <span style="color: #666666">=</span> block_tokens <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> current <span style="color: #008000; font-weight: bold">else</span> block_tokens <span style="color: #666666">+</span> sep_tokens
        <span style="color: #008000; font-weight: bold">if</span> current_tokens <span style="color: #666666">+</span> additional <span style="color: #666666">&lt;=</span> chunk_size_tokens:
            current<span style="color: #666666">.</span>append(block)
            current_tokens <span style="color: #666666">+=</span> additional
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">if</span> current:
                chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))
            current <span style="color: #666666">=</span> [block]
            current_tokens <span style="color: #666666">=</span> block_tokens

    <span style="color: #008000; font-weight: bold">if</span> current:
        chunks<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(current))

    <span style="color: #008000; font-weight: bold">return</span> chunks
</code></pre>
<h3 id="_summarize_module_chunked">_summarize_module_chunked(client: LLMClient, cache: ResponseCache, key_prefix: str, module_text: str, module: dict, tokenizer, max_context_tokens: int, chunk_token_budget: int) -&gt; str</h3>
<p>This function `_summarize_module_chunked` is designed to summarize a Python module using structure-aware chunking. It takes several parameters including an LLM client, response cache, key prefix, module text, module dictionary, tokenizer, maximum context tokens, and chunk token budget.

The function first calculates the available tokens for summarization after accounting for overhead from system prompt and template encoding. If the module text can fit within these available tokens, it proceeds to summarize directly using another internal function `_summarize`.

If the module text is too large, the function attempts to structure-awarely chunk the module into smaller parts based on its structure. Each part is then summarized individually. If structure-based chunking fails, it falls back to summarizing the entire module text.

After obtaining summaries for all chunks, the function combines these summaries into a single technical paragraph using another internal function `_merge_recursive`. This recursive merging ensures that the combined summary does not exceed the available tokens by breaking down larger parts if necessary. If merging fails, it returns a sanitized version of the partial summaries.

The final result is a summarized technical paragraph representing the module, which is then sanitized before being returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_module_chunked</span>(
    client: LLMClient,
    cache: ResponseCache,
    key_prefix: <span style="color: #008000">str</span>,
    module_text: <span style="color: #008000">str</span>,
    module: <span style="color: #008000">dict</span>,
    tokenizer,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize a module using structure-aware chunking.&quot;&quot;&quot;</span>

    template <span style="color: #666666">=</span> PROMPT_TEMPLATES[<span style="color: #BA2121">&quot;module&quot;</span>]
    overhead_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(SYSTEM_PROMPT)) <span style="color: #666666">+</span> <span style="color: #008000">len</span>(
        tokenizer<span style="color: #666666">.</span>encode(template<span style="color: #666666">.</span>format(text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;&quot;</span>))
    )
    available_tokens <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #666666">1</span>, max_context_tokens <span style="color: #666666">-</span> overhead_tokens)

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(module_text)) <span style="color: #666666">&lt;=</span> available_tokens:
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(key_prefix, module_text)
        <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, module_text, <span style="color: #BA2121">&quot;module&quot;</span>)

    chunk_size_tokens <span style="color: #666666">=</span> <span style="color: #008000">min</span>(chunk_token_budget, available_tokens)
    <span style="color: #008000; font-weight: bold">try</span>:
        parts <span style="color: #666666">=</span> _chunk_module_by_structure(module, tokenizer, chunk_size_tokens)
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARN] Structure-based chunking failed: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(key_prefix, module_text)
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, module_text, <span style="color: #BA2121">&quot;module&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
            <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(<span style="color: #BA2121">&quot;&quot;</span>)

    partials <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> idx, part <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(
        tqdm(parts, desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Summarizing chunks&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
    ):
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:part</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, part)
        <span style="color: #008000; font-weight: bold">try</span>:
            partials<span style="color: #666666">.</span>append(_summarize(client, cache, key, part, <span style="color: #BA2121">&quot;module&quot;</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - network failure</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARN] Summarization failed for chunk </span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> partials:
        <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(<span style="color: #BA2121">&quot;&quot;</span>)

    instructions <span style="color: #666666">=</span> (
        <span style="color: #BA2121">&quot;You are a documentation generator.</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Combine the following summaries into a single technical paragraph.</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Do not critique, evaluate, or offer suggestions.</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Do not speculate or use uncertain language.</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #BA2121">&quot;Only summarize what the code explicitly defines.</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span>
    )
    instr_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(instructions))
    merge_budget <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #666666">1</span>, available_tokens <span style="color: #666666">-</span> instr_tokens)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_merge_recursive</span>(items: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], depth: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">0</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        merge_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items)
        prompt <span style="color: #666666">=</span> instructions <span style="color: #666666">+</span> merge_text
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(prompt)) <span style="color: #666666">&lt;=</span> available_tokens:
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
            <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(items) <span style="color: #666666">==</span> <span style="color: #666666">1</span>:
            single <span style="color: #666666">=</span> items[<span style="color: #666666">0</span>]
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:solo&quot;</span>, single)
            <span style="color: #008000; font-weight: bold">return</span> _summarize_chunked(
                client,
                cache,
                key,
                single,
                <span style="color: #BA2121">&quot;docstring&quot;</span>,
                max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
                chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
            )
        groups: <span style="color: #008000">list</span>[<span style="color: #008000">list</span>[<span style="color: #008000">str</span>]] <span style="color: #666666">=</span> []
        current: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items:
            bullet <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
            b_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(bullet))
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">and</span> current_tokens <span style="color: #666666">+</span> b_tokens <span style="color: #666666">&gt;</span> merge_budget:
                groups<span style="color: #666666">.</span>append(current)
                current <span style="color: #666666">=</span> [p]
                current_tokens <span style="color: #666666">=</span> b_tokens
            <span style="color: #008000; font-weight: bold">else</span>:
                current<span style="color: #666666">.</span>append(p)
                current_tokens <span style="color: #666666">+=</span> b_tokens
        <span style="color: #008000; font-weight: bold">if</span> current:
            groups<span style="color: #666666">.</span>append(current)

        merged: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> idx, grp <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(groups):
            merged<span style="color: #666666">.</span>append(_merge_recursive(grp, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>))
        <span style="color: #008000; font-weight: bold">return</span> _merge_recursive(merged, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>)

    <span style="color: #008000; font-weight: bold">try</span>:
        final_summary <span style="color: #666666">=</span> _merge_recursive(partials)
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - network failure</span>
        <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;[WARN] Merge failed: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(partials))
    <span style="color: #008000; font-weight: bold">return</span> sanitize_summary(final_summary)
</code></pre>
<details>
<summary>Subfunction: _merge_recursive(items: list[str], depth: int=0) -&gt; str</summary>
<h4 id="_merge_recursive">_merge_recursive(items: list[str], depth: int=0) -&gt; str</h4>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_merge_recursive</span>(items: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], depth: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">0</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        merge_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items)
        prompt <span style="color: #666666">=</span> instructions <span style="color: #666666">+</span> merge_text
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(prompt)) <span style="color: #666666">&lt;=</span> available_tokens:
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
            <span style="color: #008000; font-weight: bold">return</span> _summarize(client, cache, key, prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(items) <span style="color: #666666">==</span> <span style="color: #666666">1</span>:
            single <span style="color: #666666">=</span> items[<span style="color: #666666">0</span>]
            key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key_prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:merge</span><span style="color: #A45A77; font-weight: bold">{</span>depth<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:solo&quot;</span>, single)
            <span style="color: #008000; font-weight: bold">return</span> _summarize_chunked(
                client,
                cache,
                key,
                single,
                <span style="color: #BA2121">&quot;docstring&quot;</span>,
                max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
                chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
            )
        groups: <span style="color: #008000">list</span>[<span style="color: #008000">list</span>[<span style="color: #008000">str</span>]] <span style="color: #666666">=</span> []
        current: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        current_tokens <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> items:
            bullet <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>p<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
            b_tokens <span style="color: #666666">=</span> <span style="color: #008000">len</span>(tokenizer<span style="color: #666666">.</span>encode(bullet))
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">and</span> current_tokens <span style="color: #666666">+</span> b_tokens <span style="color: #666666">&gt;</span> merge_budget:
                groups<span style="color: #666666">.</span>append(current)
                current <span style="color: #666666">=</span> [p]
                current_tokens <span style="color: #666666">=</span> b_tokens
            <span style="color: #008000; font-weight: bold">else</span>:
                current<span style="color: #666666">.</span>append(p)
                current_tokens <span style="color: #666666">+=</span> b_tokens
        <span style="color: #008000; font-weight: bold">if</span> current:
            groups<span style="color: #666666">.</span>append(current)

        merged: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> idx, grp <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(groups):
            merged<span style="color: #666666">.</span>append(_merge_recursive(grp, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>))
        <span style="color: #008000; font-weight: bold">return</span> _merge_recursive(merged, depth <span style="color: #666666">+</span> <span style="color: #666666">1</span>)
</code></pre>
</details>
<h3 id="_build_function_prompt">_build_function_prompt(source: str, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None) -&gt; str</h3>
<p>The function `_build_function_prompt` constructs a prompt for summarizing Python source code. It takes four parameters: `source`, `class_name`, `class_summary`, and `project_summary`. The function returns a string that includes the provided context (class name, class summary, project summary) along with instructions on how to summarize the function based on its source code.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_function_prompt</span>(
    source: <span style="color: #008000">str</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a context-enriched prompt for summarizing ``source``.&quot;&quot;&quot;</span>

    lines <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;You are a documentation generator.&quot;</span>]
    <span style="color: #008000; font-weight: bold">if</span> class_name:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;The following function is part of the class `</span><span style="color: #A45A77; font-weight: bold">{</span>class_name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">`.&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> class_summary:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;This class </span><span style="color: #A45A77; font-weight: bold">{</span>class_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> project_summary:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;This project </span><span style="color: #A45A77; font-weight: bold">{</span>project_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    lines<span style="color: #666666">.</span>extend(
        [
            <span style="color: #BA2121">&quot;Summarize the function based on its source code below.&quot;</span>,
            <span style="color: #BA2121">&quot;- Do not include assistant phrasing or usage instructions.&quot;</span>,
            <span style="color: #BA2121">&quot;- Do not mention unrelated games or systems.&quot;</span>,
            <span style="color: #BA2121">&quot;- Only use the context and code provided.&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">&quot;```python&quot;</span>,
            source,
            <span style="color: #BA2121">&quot;```&quot;</span>,
        ]
    )
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(lines)
</code></pre>
<h3 id="_rewrite_docstring">_rewrite_docstring(client: LLMClient, cache: ResponseCache, file_path: str, item: dict[str, str], *, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None, tokenizer=None, max_context_tokens: int=4096, chunk_token_budget: int=3072) -&gt; None</h3>
<p>This function `_rewrite_docstring` is designed to rewrite the docstring of a code item using an LLM client. It takes several parameters including an LLM client, a cache for responses, the file path, and details about the item such as its source code and name. The function checks if there is source code or a docstring available; if not, it prints a warning and returns. If a docstring exists, it constructs a prompt based on the provided context (class name, class summary, project summary) or uses a default prompt format. It then generates a key for caching purposes and calls `_summarize_chunked` to generate a new docstring using the LLM client. The resulting summary is sanitized and stored back in the item dictionary under the &quot;docstring&quot; key. If no summary can be generated, it defaults to &quot;No summary available.&quot;</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_rewrite_docstring</span>(
    client: LLMClient,
    cache: ResponseCache,
    file_path: <span style="color: #008000">str</span>,
    item: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">str</span>],
    <span style="color: #666666">*</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    tokenizer<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
    max_context_tokens: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">4096</span>,
    chunk_token_budget: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">3072</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Rewrite ``item`` docstring using optional context.&quot;&quot;&quot;</span>

    source <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
    docstring <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> source <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> docstring:
        <span style="color: #008000">print</span>(
            <span style="color: #BA2121">f&quot;Warning: no source or docstring for </span><span style="color: #A45A77; font-weight: bold">{</span>file_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
        )
        <span style="color: #008000; font-weight: bold">return</span>

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> docstring:
        <span style="color: #008000; font-weight: bold">return</span>

    <span style="color: #008000; font-weight: bold">if</span> class_name <span style="color: #AA22FF; font-weight: bold">or</span> class_summary <span style="color: #AA22FF; font-weight: bold">or</span> project_summary:
        prompt <span style="color: #666666">=</span> _build_function_prompt(
            source,
            class_name<span style="color: #666666">=</span>class_name,
            class_summary<span style="color: #666666">=</span>class_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
        )
        key_content <span style="color: #666666">=</span> source <span style="color: #666666">+</span> (class_name <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> (class_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> (project_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        prompt <span style="color: #666666">=</span> DOC_PROMPT<span style="color: #666666">.</span>format(source<span style="color: #666666">=</span>source, docstring<span style="color: #666666">=</span>docstring)
        key_content <span style="color: #666666">=</span> source <span style="color: #666666">+</span> docstring

    key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
        <span style="color: #BA2121">f&quot;REWRITE:</span><span style="color: #A45A77; font-weight: bold">{</span>file_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
        key_content,
    )
    result <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        key,
        prompt,
        <span style="color: #BA2121">&quot;docstring&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    item[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> sanitize_summary(result) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;No summary available.&quot;</span>
</code></pre>
<h3 id="_summarize_members_recursive">_summarize_members_recursive(class_data: dict[str, Any], path: str, client: LLMClient, cache: ResponseCache, tokenizer, max_context_tokens: int, chunk_token_budget: int) -&gt; None</h3>
<p>The function `_summarize_members_recursive` is designed to recursively summarize the methods and variables of a class, as well as any subclasses. It takes several parameters including `class_data`, which contains information about the class and its members; `path`, which represents the path to the source file; `client`, an LLM client for text generation; `cache`, a caching mechanism to store summaries; `tokenizer`, likely used for tokenization; and `max_context_tokens` and `chunk_token_budget` for managing text length.

The function iterates over methods and variables in `class_data`, summarizing each using the `_summarize_chunked` function. It then assigns these summaries back to the respective method or variable objects within `class_data`. For subclasses, it recursively calls itself to ensure all members of the subclass hierarchy are summarized. This approach ensures that the documentation is comprehensive and covers all levels of nested classes and methods.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_members_recursive</span>(
    class_data: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
    path: <span style="color: #008000">str</span>,
    client: LLMClient,
    cache: ResponseCache,
    tokenizer,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize methods and variables of ``class_data`` and any subclasses.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;methods&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
        src <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
            <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, src
        )
        summary <span style="color: #666666">=</span> _summarize_chunked(
            client,
            cache,
            key,
            src,
            <span style="color: #BA2121">&quot;function&quot;</span>,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )
        method[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> summary
        method[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> summary

    <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;variables&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
        src <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
            <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, src
        )
        summary <span style="color: #666666">=</span> _summarize_chunked(
            client,
            cache,
            key,
            src,
            <span style="color: #BA2121">&quot;function&quot;</span>,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )
        var[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> summary
        var[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> summary

    <span style="color: #008000; font-weight: bold">for</span> sub <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;subclasses&quot;</span>, []):
        _summarize_members_recursive(
            sub,
            path,
            client,
            cache,
            tokenizer,
            max_context_tokens,
            chunk_token_budget,
        )
</code></pre>
<h3 id="_summarize_class_recursive">_summarize_class_recursive(class_data: dict[str, Any], path: str, project_summary: str, tokenizer, client: LLMClient, cache: ResponseCache, max_context_tokens: int, chunk_token_budget: int) -&gt; None</h3>
<p>This function `_summarize_class_recursive` recursively summarizes a class and its members by generating summaries for methods, variables, and subclasses. It uses an LLM client to interact with a language model for text generation, caches responses to improve performance, and sanitizes the generated summaries. The function updates the original class data with new summaries and rewrites docstrings where necessary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize_class_recursive</span>(
    class_data: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
    path: <span style="color: #008000">str</span>,
    project_summary: <span style="color: #008000">str</span>,
    tokenizer,
    client: LLMClient,
    cache: ResponseCache,
    max_context_tokens: <span style="color: #008000">int</span>,
    chunk_token_budget: <span style="color: #008000">int</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Summarize ``class_data`` and rewrite its docstring and methods.&quot;&quot;&quot;</span>

    _summarize_members_recursive(
        class_data,
        path,
        client,
        cache,
        tokenizer,
        max_context_tokens,
        chunk_token_budget,
    )

    method_lines <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
        summary <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        name <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        method_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">if</span> summary <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    methods_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(method_lines) <span style="color: #008000; font-weight: bold">if</span> method_lines <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;- (no methods)&quot;</span>

    var_lines <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []):
        summary <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))
        name <span style="color: #666666">=</span> var<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        var_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">if</span> summary <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    variables_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(var_lines) <span style="color: #008000; font-weight: bold">if</span> var_lines <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;- (no variables)&quot;</span>

    class_prompt <span style="color: #666666">=</span> CLASS_PROMPT<span style="color: #666666">.</span>format(
        class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>),
        project_summary<span style="color: #666666">=</span>project_summary,
        methods<span style="color: #666666">=</span>methods_text,
        variables<span style="color: #666666">=</span>variables_text,
    )
    cls_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, class_prompt)
    cls_summary <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        cls_key,
        class_prompt,
        <span style="color: #BA2121">&quot;docstring&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    cls_summary <span style="color: #666666">=</span> sanitize_summary(cls_summary)
    original_doc <span style="color: #666666">=</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
    class_data[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> cls_summary
    class_data[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> cls_summary
    <span style="color: #008000; font-weight: bold">if</span> original_doc:
        class_data[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> original_doc
        _rewrite_docstring(
            client,
            cache,
            path,
            class_data,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
        _rewrite_docstring(
            client,
            cache,
            path,
            method,
            class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>),
            class_summary<span style="color: #666666">=</span>cls_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> var <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;variables&quot;</span>, []):
        _rewrite_docstring(
            client,
            cache,
            path,
            var,
            class_name<span style="color: #666666">=</span>class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>),
            class_summary<span style="color: #666666">=</span>cls_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
            tokenizer<span style="color: #666666">=</span>tokenizer,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )

    <span style="color: #008000; font-weight: bold">for</span> sub <span style="color: #AA22FF; font-weight: bold">in</span> class_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;subclasses&quot;</span>, []):
        _summarize_class_recursive(
            sub,
            path,
            project_summary,
            tokenizer,
            client,
            cache,
            max_context_tokens,
            chunk_token_budget,
        )
</code></pre>
<h3 id="main">main(argv: list[str] | None=None) -&gt; int</h3>
<p>The `main` function serves as the entry point for generating HTML documentation from source files. It parses command-line arguments to configure settings such as the source directory, output directory, ignored paths, and LLM client details. The function initializes an LLM client, sets up a tokenizer, and creates necessary directories for the output.

It then scans the source directory for relevant files (Python, C++, Java, MATLAB) and parses them into structured data using language-specific parsing functions. For each file, it generates summaries of modules, classes, and functions by interacting with an LLM client. The summaries are cached to improve performance.

After processing all files, the function constructs a project outline and gathers markdown documentation from README and docs directories. It then summarizes the project structure and any additional markdown content using the LLM client.

Finally, the function generates index and module pages for the documentation, incorporating the generated summaries and linking them appropriately. The function returns 0 to indicate successful execution.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(argv: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser(description<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Generate HTML documentation using a local LLM&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&quot;source&quot;</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Path to the source directory&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&quot;--output&quot;</span>, required<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Destination directory for HTML output&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--ignore&quot;</span>,
        action<span style="color: #666666">=</span><span style="color: #BA2121">&quot;append&quot;</span>,
        default<span style="color: #666666">=</span>[],
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Paths relative to source that should be ignored (repeatable)&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--llm-url&quot;</span>,
        default<span style="color: #666666">=</span><span style="color: #BA2121">&quot;http://localhost:1234&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Base URL of the LLM API&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--model&quot;</span>,
        default<span style="color: #666666">=</span><span style="color: #BA2121">&quot;local&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Model name to use when contacting the LLM&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--max-context-tokens&quot;</span>,
        <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">int</span>,
        default<span style="color: #666666">=4096</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Maximum token context window for the LLM&quot;</span>,
    )
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args(argv)

    client <span style="color: #666666">=</span> LLMClient(base_url<span style="color: #666666">=</span>args<span style="color: #666666">.</span>llm_url, model<span style="color: #666666">=</span>args<span style="color: #666666">.</span>model)
    <span style="color: #008000; font-weight: bold">try</span>:
        client<span style="color: #666666">.</span>ping()
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ConnectionError</span> <span style="color: #008000; font-weight: bold">as</span> exc:
        <span style="color: #008000">print</span>(<span style="color: #008000">str</span>(exc), file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1</span>

    tokenizer <span style="color: #666666">=</span> get_tokenizer()
    max_context_tokens <span style="color: #666666">=</span> args<span style="color: #666666">.</span>max_context_tokens
    chunk_token_budget <span style="color: #666666">=</span> <span style="color: #008000">int</span>(max_context_tokens <span style="color: #666666">*</span> <span style="color: #666666">0.75</span>)

    output_dir <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>output)
    output_dir<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    clean_output_dir(<span style="color: #008000">str</span>(output_dir))
    static_dir <span style="color: #666666">=</span> Path(<span style="color: #19177C">__file__</span>)<span style="color: #666666">.</span>parent <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;static&quot;</span>
    <span style="color: #3D7B7B; font-style: italic"># use absolute path so execution works from any current working directory</span>
    shutil<span style="color: #666666">.</span>copytree(static_dir, output_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;static&quot;</span>, dirs_exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)

    cache <span style="color: #666666">=</span> ResponseCache(<span style="color: #008000">str</span>(output_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;cache.json&quot;</span>))

    files <span style="color: #666666">=</span> scan_directory(args<span style="color: #666666">.</span>source, args<span style="color: #666666">.</span>ignore)
    modules <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(files, desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Processing modules&quot;</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            text <span style="color: #666666">=</span> Path(path)<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">UnicodeDecodeError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># skip files with invalid encoding</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">if</span> path<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.py&quot;</span>):
                parsed <span style="color: #666666">=</span> parse_python_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;python&quot;</span>
            <span style="color: #008000; font-weight: bold">elif</span> path<span style="color: #666666">.</span>endswith((<span style="color: #BA2121">&quot;.cpp&quot;</span>, <span style="color: #BA2121">&quot;.h&quot;</span>)):
                parsed <span style="color: #666666">=</span> parse_cpp_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;cpp&quot;</span>
            <span style="color: #008000; font-weight: bold">elif</span> path<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.java&quot;</span>):
                parsed <span style="color: #666666">=</span> parse_java_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;java&quot;</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                parsed <span style="color: #666666">=</span> parse_matlab_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;matlab&quot;</span>
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">SyntaxError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># malformed file should be ignored</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
            <span style="color: #008000; font-weight: bold">continue</span>

        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(path, text)
        summary <span style="color: #666666">=</span> _summarize_module_chunked(
            client,
            cache,
            key,
            text,
            parsed,
            tokenizer,
            max_context_tokens,
            chunk_token_budget,
        )

        module <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;name&quot;</span>: Path(path)<span style="color: #666666">.</span>stem,
            <span style="color: #BA2121">&quot;language&quot;</span>: language,
            <span style="color: #BA2121">&quot;summary&quot;</span>: summary,
            <span style="color: #BA2121">&quot;filename&quot;</span>: Path(path)<span style="color: #666666">.</span>name,
            <span style="color: #BA2121">&quot;path&quot;</span>: path,
        }
        module<span style="color: #666666">.</span>update(parsed)

        <span style="color: #3D7B7B; font-style: italic"># summarize methods now so class summaries can reference them later</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>module[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: classes&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            _summarize_members_recursive(
                <span style="color: #008000">cls</span>,
                path,
                client,
                cache,
                tokenizer,
                max_context_tokens,
                chunk_token_budget,
            )

        <span style="color: #3D7B7B; font-style: italic"># and for standalone functions (summarized later with project context)</span>
        <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;methods&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            func[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>

        modules<span style="color: #666666">.</span>append(module)

    page_links <span style="color: #666666">=</span> [(m[<span style="color: #BA2121">&quot;name&quot;</span>], <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>m[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.html&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> modules]

    project_lines <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;Project structure:&quot;</span>]
    <span style="color: #008000; font-weight: bold">for</span> mod <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>mod[<span style="color: #BA2121">&#39;filename&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        classes <span style="color: #666666">=</span> mod<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []) <span style="color: #AA22FF; font-weight: bold">or</span> []
        functions <span style="color: #666666">=</span> mod<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []) <span style="color: #AA22FF; font-weight: bold">or</span> []

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> classes <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> functions:
            <span style="color: #008000">print</span>(
                <span style="color: #BA2121">f&quot;Warning: </span><span style="color: #A45A77; font-weight: bold">{</span>mod[<span style="color: #BA2121">&#39;filename&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> has no classes or functions&quot;</span>,
                file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
            )
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;  - (no classes or functions defined)&quot;</span>)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> classes:
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;  - Class: </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            method_names <span style="color: #666666">=</span> [m<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, [])]
            methods_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(method_names) <span style="color: #008000; font-weight: bold">if</span> method_names <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;(none)&quot;</span>
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;    - Methods: </span><span style="color: #A45A77; font-weight: bold">{</span>methods_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

        <span style="color: #008000; font-weight: bold">if</span> functions:
            func_names <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(f<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> f <span style="color: #AA22FF; font-weight: bold">in</span> functions)
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;  - Functions: </span><span style="color: #A45A77; font-weight: bold">{</span>func_names<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    project_outline <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(project_lines)

    <span style="color: #3D7B7B; font-style: italic"># gather markdown documentation</span>
    md_files: <span style="color: #008000">list</span>[Path] <span style="color: #666666">=</span> []
    readme <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>source) <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;README.md&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> readme<span style="color: #666666">.</span>exists():
        md_files<span style="color: #666666">.</span>append(readme)

    base <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>source)<span style="color: #666666">.</span>resolve()
    ignore_paths <span style="color: #666666">=</span> {(base <span style="color: #666666">/</span> p)<span style="color: #666666">.</span>resolve() <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> args<span style="color: #666666">.</span>ignore}

    <span style="color: #008000; font-weight: bold">for</span> root, dirs, _files <span style="color: #AA22FF; font-weight: bold">in</span> os<span style="color: #666666">.</span>walk(base, topdown<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, followlinks<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
        root_path <span style="color: #666666">=</span> Path(root)

        <span style="color: #3D7B7B; font-style: italic"># prune symlinks and ignored directories</span>
        pruned: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dirs:
            dir_path <span style="color: #666666">=</span> root_path <span style="color: #666666">/</span> d
            <span style="color: #008000; font-weight: bold">if</span> dir_path<span style="color: #666666">.</span>is_symlink():
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">any</span>(_is_subpath((dir_path)<span style="color: #666666">.</span>resolve(), ig) <span style="color: #008000; font-weight: bold">for</span> ig <span style="color: #AA22FF; font-weight: bold">in</span> ignore_paths):
                <span style="color: #008000; font-weight: bold">continue</span>
            pruned<span style="color: #666666">.</span>append(d)
        dirs[:] <span style="color: #666666">=</span> pruned

        docs_dirs <span style="color: #666666">=</span> [d <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dirs <span style="color: #008000; font-weight: bold">if</span> d<span style="color: #666666">.</span>lower() <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;docs&quot;</span>]
        <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> docs_dirs:
            docs_path <span style="color: #666666">=</span> root_path <span style="color: #666666">/</span> d
            <span style="color: #008000; font-weight: bold">for</span> r, d2, f2 <span style="color: #AA22FF; font-weight: bold">in</span> os<span style="color: #666666">.</span>walk(docs_path, topdown<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, followlinks<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
                r_path <span style="color: #666666">=</span> Path(r)
                d2[:] <span style="color: #666666">=</span> [
                    dd
                    <span style="color: #008000; font-weight: bold">for</span> dd <span style="color: #AA22FF; font-weight: bold">in</span> d2
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> (r_path <span style="color: #666666">/</span> dd)<span style="color: #666666">.</span>is_symlink()
                    <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">any</span>(_is_subpath((r_path <span style="color: #666666">/</span> dd)<span style="color: #666666">.</span>resolve(), ig) <span style="color: #008000; font-weight: bold">for</span> ig <span style="color: #AA22FF; font-weight: bold">in</span> ignore_paths)
                ]
                <span style="color: #008000; font-weight: bold">for</span> name <span style="color: #AA22FF; font-weight: bold">in</span> f2:
                    <span style="color: #008000; font-weight: bold">if</span> name<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.md&quot;</span>):
                        md_files<span style="color: #666666">.</span>append(Path(r_path) <span style="color: #666666">/</span> name)

        <span style="color: #3D7B7B; font-style: italic"># prevent os.walk from recursing into docs directories again</span>
        dirs[:] <span style="color: #666666">=</span> [d <span style="color: #008000; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> dirs <span style="color: #008000; font-weight: bold">if</span> d<span style="color: #666666">.</span>lower() <span style="color: #666666">!=</span> <span style="color: #BA2121">&quot;docs&quot;</span>]

    md_parts <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> md_file <span style="color: #AA22FF; font-weight: bold">in</span> md_files:
        <span style="color: #008000; font-weight: bold">try</span>:
            md_parts<span style="color: #666666">.</span>append(md_file<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&#39;utf-8&#39;</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - filesystem edge case</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>md_file<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)

    md_context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(md_parts)<span style="color: #666666">.</span>strip()
    readme_summary <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> md_context:
        readme_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">&quot;README&quot;</span>, md_context)
        readme_summary <span style="color: #666666">=</span> _summarize_chunked(
            client,
            cache,
            readme_key,
            md_context,
            <span style="color: #BA2121">&quot;readme&quot;</span>,
            max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
            chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
        )
        readme_summary <span style="color: #666666">=</span> sanitize_summary(readme_summary)

    project_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">&quot;PROJECT&quot;</span>, project_outline)
    raw_summary <span style="color: #666666">=</span> _summarize_chunked(
        client,
        cache,
        project_key,
        project_outline,
        <span style="color: #BA2121">&quot;project&quot;</span>,
        max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
        chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
    )
    project_summary <span style="color: #666666">=</span> sanitize_summary(raw_summary)
    <span style="color: #008000; font-weight: bold">if</span> readme_summary:
        project_summary <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>readme_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>project_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>strip()

    <span style="color: #3D7B7B; font-style: italic"># Now that the project summary is available, generate class and function summaries</span>
    <span style="color: #3D7B7B; font-style: italic"># and rewrite method/function docstrings with context.</span>
    <span style="color: #008000; font-weight: bold">for</span> module <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        path <span style="color: #666666">=</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>module[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: classes&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            _summarize_class_recursive(
                <span style="color: #008000">cls</span>,
                path,
                project_summary,
                tokenizer,
                client,
                cache,
                max_context_tokens,
                chunk_token_budget,
            )
        <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> tqdm(module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []), desc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;methods&quot;</span>, leave<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>):
            src <span style="color: #666666">=</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
            prompt <span style="color: #666666">=</span> _build_function_prompt(src, project_summary<span style="color: #666666">=</span>project_summary)
            func_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
            func_summary <span style="color: #666666">=</span> _summarize_chunked(
                client,
                cache,
                func_key,
                prompt,
                <span style="color: #BA2121">&quot;docstring&quot;</span>,
                max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
                chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
            )
            func[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> func_summary
            _rewrite_docstring(
                client,
                cache,
                path,
                func,
                project_summary<span style="color: #666666">=</span>project_summary,
                tokenizer<span style="color: #666666">=</span>tokenizer,
                max_context_tokens<span style="color: #666666">=</span>max_context_tokens,
                chunk_token_budget<span style="color: #666666">=</span>chunk_token_budget,
            )

    module_summaries <span style="color: #666666">=</span> {m[<span style="color: #BA2121">&quot;name&quot;</span>]: m<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> modules}
    write_index(<span style="color: #008000">str</span>(output_dir), project_summary, page_links, module_summaries)
    <span style="color: #008000; font-weight: bold">for</span> module <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        write_module_page(<span style="color: #008000">str</span>(output_dir), module, page_links)

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0</span>
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
