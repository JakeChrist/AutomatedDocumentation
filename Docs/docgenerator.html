<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>docgenerator</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul>
        <li><a href="index.html"><strong>üè† Project Overview</strong></a></li>
<li><a href="cache.html">cache</a></li>
<li><a href="docgenerator.html">docgenerator</a></li>
<li><a href="html_writer.html">html_writer</a></li>
<li><a href="llm_client.html">llm_client</a></li>
<li><a href="parser_matlab.html">parser_matlab</a></li>
<li><a href="parser_python.html">parser_python</a></li>
<li><a href="reviewer.html">reviewer</a></li>
<li><a href="scanner.html">scanner</a></li>
<li><a href="test_cache.html">test_cache</a></li>
<li><a href="test_docgenerator.html">test_docgenerator</a></li>
<li><a href="test_html_writer.html">test_html_writer</a></li>
<li><a href="test_integration.html">test_integration</a></li>
<li><a href="test_llm_client.html">test_llm_client</a></li>
<li><a href="test_parser_matlab.html">test_parser_matlab</a></li>
<li><a href="test_parser_python.html">test_parser_python</a></li>
<li><a href="test_reviewer.html">test_reviewer</a></li>
<li><a href="test_scanner.html">test_scanner</a></li>
        </ul>
    </div>
    <div class="content">
        <h1>docgenerator</h1>
        <p>This Python script generates HTML documentation for a project by scanning directories for Python and MATLAB files. It uses a locally running language model (LLM) to parse the code, request summaries, and write the documentation. The script handles command-line arguments for source directory, output directory, ignored paths, LLM URL, and model name. It processes each file, parses its content, and requests summaries for modules, classes, methods, and standalone functions. Summaries are cached to avoid redundant requests. Finally, it writes an index page and individual module pages with the generated documentation.</p>
<h2>Functions</h2>
<h3 id="_summarize">_summarize(client: LLMClient, cache: ResponseCache, key: str, text: str, prompt_type: str) -&gt; str</h3>
<p>This function `_summarize` takes an `LLMClient`, a `ResponseCache`, a `key`, a `text`, and a `prompt_type` as parameters. It checks if the summary for the given key is already cached. If it is, it returns the cached summary. Otherwise, it uses the LLM client to generate a new summary for the text based on the prompt type, caches this new summary under the specified key, and then returns it.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_summarize</span>(client: LLMClient, cache: ResponseCache, key: <span style="color: #008000">str</span>, text: <span style="color: #008000">str</span>, prompt_type: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
    cached <span style="color: #666666">=</span> cache<span style="color: #666666">.</span>get(key)
    <span style="color: #008000; font-weight: bold">if</span> cached <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">return</span> cached
    summary <span style="color: #666666">=</span> client<span style="color: #666666">.</span>summarize(text, prompt_type)
    cache<span style="color: #666666">.</span>set(key, summary)
    <span style="color: #008000; font-weight: bold">return</span> summary
</code></pre>
<h3 id="_build_function_prompt">_build_function_prompt(source: str, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None) -&gt; str</h3>
<p>The function `_build_function_prompt` constructs a context-enriched prompt for summarizing Python code. It takes the source code of a function, along with optional class and project summaries, and returns a string that includes these contexts followed by instructions on how to summarize the function based solely on its source code.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_function_prompt</span>(
    source: <span style="color: #008000">str</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a context-enriched prompt for summarizing ``source``.&quot;&quot;&quot;</span>

    lines <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;You are a documentation generator.&quot;</span>]
    <span style="color: #008000; font-weight: bold">if</span> class_name:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;The following function is part of the class `</span><span style="color: #A45A77; font-weight: bold">{</span>class_name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">`.&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> class_summary:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;This class </span><span style="color: #A45A77; font-weight: bold">{</span>class_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> project_summary:
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;This project </span><span style="color: #A45A77; font-weight: bold">{</span>project_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    lines<span style="color: #666666">.</span>extend(
        [
            <span style="color: #BA2121">&quot;Summarize the function based on its source code below.&quot;</span>,
            <span style="color: #BA2121">&quot;- Do not include assistant phrasing or usage instructions.&quot;</span>,
            <span style="color: #BA2121">&quot;- Do not mention unrelated games or systems.&quot;</span>,
            <span style="color: #BA2121">&quot;- Only use the context and code provided.&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">&quot;```python&quot;</span>,
            source,
            <span style="color: #BA2121">&quot;```&quot;</span>,
        ]
    )
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(lines)
</code></pre>
<h3 id="_rewrite_docstring">_rewrite_docstring(client: LLMClient, cache: ResponseCache, file_path: str, item: dict[str, str], *, class_name: str | None=None, class_summary: str | None=None, project_summary: str | None=None) -&gt; None</h3>
<p>The function `_rewrite_docstring` takes an `LLMClient`, a `ResponseCache`, a file path, and a dictionary representing an item with source code and a docstring. It optionally accepts class name, class summary, and project summary for context. The function checks if the source or docstring is empty and prints a warning if so. It constructs a prompt based on the provided context or default `DOC_PROMPT`. A cache key is generated using the file path, item name, and key content. If the result is available in the cache, it uses that; otherwise, it generates a summary using the LLM client and updates the item&#x27;s docstring with the sanitized result or &quot;No summary available.&quot;</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_rewrite_docstring</span>(
    client: LLMClient,
    cache: ResponseCache,
    file_path: <span style="color: #008000">str</span>,
    item: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">str</span>],
    <span style="color: #666666">*</span>,
    class_name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    class_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    project_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Rewrite ``item`` docstring using optional context.&quot;&quot;&quot;</span>

    source <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
    docstring <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;docstring&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> source <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> docstring:
        <span style="color: #008000">print</span>(
            <span style="color: #BA2121">f&quot;Warning: no source or docstring for </span><span style="color: #A45A77; font-weight: bold">{</span>file_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
        )
        <span style="color: #008000; font-weight: bold">return</span>

    <span style="color: #008000; font-weight: bold">if</span> class_name <span style="color: #AA22FF; font-weight: bold">or</span> class_summary <span style="color: #AA22FF; font-weight: bold">or</span> project_summary:
        prompt <span style="color: #666666">=</span> _build_function_prompt(
            source,
            class_name<span style="color: #666666">=</span>class_name,
            class_summary<span style="color: #666666">=</span>class_summary,
            project_summary<span style="color: #666666">=</span>project_summary,
        )
        key_content <span style="color: #666666">=</span> source <span style="color: #666666">+</span> (class_name <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> (class_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> (project_summary <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        prompt <span style="color: #666666">=</span> DOC_PROMPT<span style="color: #666666">.</span>format(source<span style="color: #666666">=</span>source, docstring<span style="color: #666666">=</span>docstring)
        key_content <span style="color: #666666">=</span> source <span style="color: #666666">+</span> docstring

    key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
        <span style="color: #BA2121">f&quot;REWRITE:</span><span style="color: #A45A77; font-weight: bold">{</span>file_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
        key_content,
    )
    result <span style="color: #666666">=</span> _summarize(client, cache, key, prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
    item[<span style="color: #BA2121">&quot;docstring&quot;</span>] <span style="color: #666666">=</span> sanitize_summary(result) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;No summary available.&quot;</span>
</code></pre>
<h3 id="main">main(argv: list[str] | None=None) -&gt; int</h3>
<p>The `main` function serves as the entry point for generating HTML documentation using a local Large Language Model (LLM). It parses command-line arguments to specify the source directory, output location, and optional parameters such as LLM server URL and model name. The function initializes an LLM client, checks connectivity, sets up directories, and processes Python and MATLAB files within the source directory. It generates summaries for modules, classes, methods, functions, and the project itself using the LLM. Summaries are cached to avoid redundant requests. Finally, it writes HTML documentation pages based on the generated summaries and project structure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(argv: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser(description<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Generate HTML documentation using a local LLM&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&quot;source&quot;</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Path to the source directory&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&quot;--output&quot;</span>, required<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Destination directory for HTML output&quot;</span>)
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--ignore&quot;</span>,
        action<span style="color: #666666">=</span><span style="color: #BA2121">&quot;append&quot;</span>,
        default<span style="color: #666666">=</span>[],
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Paths relative to source that should be ignored (repeatable)&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--llm-url&quot;</span>,
        default<span style="color: #666666">=</span><span style="color: #BA2121">&quot;http://localhost:1234&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Base URL of the LLM API&quot;</span>,
    )
    parser<span style="color: #666666">.</span>add_argument(
        <span style="color: #BA2121">&quot;--model&quot;</span>,
        default<span style="color: #666666">=</span><span style="color: #BA2121">&quot;local&quot;</span>,
        help<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Model name to use when contacting the LLM&quot;</span>,
    )
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args(argv)

    client <span style="color: #666666">=</span> LLMClient(base_url<span style="color: #666666">=</span>args<span style="color: #666666">.</span>llm_url, model<span style="color: #666666">=</span>args<span style="color: #666666">.</span>model)
    <span style="color: #008000; font-weight: bold">try</span>:
        client<span style="color: #666666">.</span>ping()
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ConnectionError</span> <span style="color: #008000; font-weight: bold">as</span> exc:
        <span style="color: #008000">print</span>(<span style="color: #008000">str</span>(exc), file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1</span>

    output_dir <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>output)
    output_dir<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    static_dir <span style="color: #666666">=</span> Path(<span style="color: #19177C">__file__</span>)<span style="color: #666666">.</span>parent <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;static&quot;</span>
    <span style="color: #3D7B7B; font-style: italic"># use absolute path so execution works from any current working directory</span>
    shutil<span style="color: #666666">.</span>copytree(static_dir, output_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;static&quot;</span>, dirs_exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)

    cache <span style="color: #666666">=</span> ResponseCache(<span style="color: #008000">str</span>(output_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;cache.json&quot;</span>))

    files <span style="color: #666666">=</span> scan_directory(args<span style="color: #666666">.</span>source, args<span style="color: #666666">.</span>ignore)
    modules <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> files:
        <span style="color: #008000; font-weight: bold">try</span>:
            text <span style="color: #666666">=</span> Path(path)<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">UnicodeDecodeError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># skip files with invalid encoding</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">if</span> path<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.py&quot;</span>):
                parsed <span style="color: #666666">=</span> parse_python_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;python&quot;</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                parsed <span style="color: #666666">=</span> parse_matlab_file(path)
                language <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;matlab&quot;</span>
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">SyntaxError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># malformed file should be ignored</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)
            <span style="color: #008000; font-weight: bold">continue</span>

        key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(path, text)
        summary <span style="color: #666666">=</span> _summarize(client, cache, key, text, <span style="color: #BA2121">&quot;module&quot;</span>)

        module <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;name&quot;</span>: Path(path)<span style="color: #666666">.</span>stem,
            <span style="color: #BA2121">&quot;language&quot;</span>: language,
            <span style="color: #BA2121">&quot;summary&quot;</span>: summary,
            <span style="color: #BA2121">&quot;filename&quot;</span>: Path(path)<span style="color: #666666">.</span>name,
            <span style="color: #BA2121">&quot;path&quot;</span>: path,
        }
        module<span style="color: #666666">.</span>update(parsed)

        <span style="color: #3D7B7B; font-style: italic"># summarize methods now so class summaries can reference them later</span>
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []):
            <span style="color: #008000">cls</span>[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
            <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
                src <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
                m_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(
                    <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, src
                )
                method_summary <span style="color: #666666">=</span> _summarize(client, cache, m_key, src, <span style="color: #BA2121">&quot;function&quot;</span>)
                method[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> method_summary

        <span style="color: #3D7B7B; font-style: italic"># and for standalone functions (summarized later with project context)</span>
        <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []):
            func[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>

        modules<span style="color: #666666">.</span>append(module)

    page_links <span style="color: #666666">=</span> [(m[<span style="color: #BA2121">&quot;name&quot;</span>], <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>m[<span style="color: #BA2121">&#39;name&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.html&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> modules]

    project_lines <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;Project structure:&quot;</span>]
    <span style="color: #008000; font-weight: bold">for</span> mod <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>mod[<span style="color: #BA2121">&#39;filename&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        classes <span style="color: #666666">=</span> mod<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []) <span style="color: #AA22FF; font-weight: bold">or</span> []
        functions <span style="color: #666666">=</span> mod<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []) <span style="color: #AA22FF; font-weight: bold">or</span> []

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> classes <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> functions:
            <span style="color: #008000">print</span>(
                <span style="color: #BA2121">f&quot;Warning: </span><span style="color: #A45A77; font-weight: bold">{</span>mod[<span style="color: #BA2121">&#39;filename&#39;</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> has no classes or functions&quot;</span>,
                file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr,
            )
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;  - (no classes or functions defined)&quot;</span>)
            <span style="color: #008000; font-weight: bold">continue</span>

        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> classes:
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;  - Class: </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            method_names <span style="color: #666666">=</span> [m<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, [])]
            methods_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(method_names) <span style="color: #008000; font-weight: bold">if</span> method_names <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;(none)&quot;</span>
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;    - Methods: </span><span style="color: #A45A77; font-weight: bold">{</span>methods_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

        <span style="color: #008000; font-weight: bold">if</span> functions:
            func_names <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(f<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> f <span style="color: #AA22FF; font-weight: bold">in</span> functions)
            project_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;  - Functions: </span><span style="color: #A45A77; font-weight: bold">{</span>func_names<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

    project_outline <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(project_lines)

    <span style="color: #3D7B7B; font-style: italic"># gather markdown documentation</span>
    md_files <span style="color: #666666">=</span> []
    readme <span style="color: #666666">=</span> Path(args<span style="color: #666666">.</span>source) <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;README.md&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> readme<span style="color: #666666">.</span>exists():
        md_files<span style="color: #666666">.</span>append(readme)
    <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> Path(args<span style="color: #666666">.</span>source)<span style="color: #666666">.</span>rglob(<span style="color: #BA2121">&#39;*&#39;</span>):
        <span style="color: #008000; font-weight: bold">if</span> p<span style="color: #666666">.</span>is_dir() <span style="color: #AA22FF; font-weight: bold">and</span> p<span style="color: #666666">.</span>name<span style="color: #666666">.</span>lower() <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;docs&#39;</span>:
            <span style="color: #008000; font-weight: bold">for</span> md <span style="color: #AA22FF; font-weight: bold">in</span> p<span style="color: #666666">.</span>rglob(<span style="color: #BA2121">&#39;*.md&#39;</span>):
                md_files<span style="color: #666666">.</span>append(md)

    md_parts <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> md_file <span style="color: #AA22FF; font-weight: bold">in</span> md_files:
        <span style="color: #008000; font-weight: bold">try</span>:
            md_parts<span style="color: #666666">.</span>append(md_file<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&#39;utf-8&#39;</span>))
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - filesystem edge case</span>
            <span style="color: #008000">print</span>(<span style="color: #BA2121">f&quot;Skipping </span><span style="color: #A45A77; font-weight: bold">{</span>md_file<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, file<span style="color: #666666">=</span>sys<span style="color: #666666">.</span>stderr)

    md_context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(md_parts)<span style="color: #666666">.</span>strip()
    readme_summary <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> md_context:
        readme_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">&quot;README&quot;</span>, md_context)
        readme_summary <span style="color: #666666">=</span> _summarize(client, cache, readme_key, md_context, <span style="color: #BA2121">&quot;readme&quot;</span>)
        readme_summary <span style="color: #666666">=</span> sanitize_summary(readme_summary)

    PROJECT_PROMPT <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;&quot;&quot;</span>
<span style="color: #BA2121">Summarize the purpose of this codebase in 1‚Äì2 sentences.</span>

<span style="color: #BA2121">- Base your answer only on the provided structure.</span>
<span style="color: #BA2121">- Do not address the reader or give usage advice.</span>
<span style="color: #BA2121">- Do not say &quot;the code defines&quot; or &quot;this summary&quot;.</span>
<span style="color: #BA2121">- Prefer concise technical descriptions of what is implemented.</span>
<span style="color: #BA2121">- Feel free to group related functionality (e.g., grid setup, game loop).</span>

<span style="color: #BA2121">Structure:</span>
<span style="color: #A45A77; font-weight: bold">{</span>project_outline<span style="color: #A45A77; font-weight: bold">}</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span>

    project_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">&quot;PROJECT&quot;</span>, project_outline)
    raw_summary <span style="color: #666666">=</span> _summarize(client, cache, project_key, PROJECT_PROMPT, <span style="color: #BA2121">&quot;docstring&quot;</span>)
    project_summary <span style="color: #666666">=</span> sanitize_summary(raw_summary)
    <span style="color: #008000; font-weight: bold">if</span> readme_summary:
        project_summary <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>readme_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>project_summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>strip()

    <span style="color: #3D7B7B; font-style: italic"># Now that the project summary is available, generate class and function summaries</span>
    <span style="color: #3D7B7B; font-style: italic"># and rewrite method/function docstrings with context.</span>
    <span style="color: #008000; font-weight: bold">for</span> module <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        path <span style="color: #666666">=</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> <span style="color: #008000">cls</span> <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;classes&quot;</span>, []):
            method_lines <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
                summary <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
                name <span style="color: #666666">=</span> method<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> summary:
                    method_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
                <span style="color: #008000; font-weight: bold">else</span>:
                    method_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            methods_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(method_lines) <span style="color: #008000; font-weight: bold">if</span> method_lines <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;- (no methods)&quot;</span>
            class_prompt <span style="color: #666666">=</span> CLASS_PROMPT<span style="color: #666666">.</span>format(
                class_name<span style="color: #666666">=</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>),
                project_summary<span style="color: #666666">=</span>project_summary,
                methods<span style="color: #666666">=</span>methods_text,
            )
            cls_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, class_prompt)
            cls_summary <span style="color: #666666">=</span> _summarize(client, cache, cls_key, class_prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
            <span style="color: #008000">cls</span>[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> cls_summary
            _rewrite_docstring(client, cache, path, <span style="color: #008000">cls</span>)

            <span style="color: #008000; font-weight: bold">for</span> method <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;methods&quot;</span>, []):
                _rewrite_docstring(
                    client,
                    cache,
                    path,
                    method,
                    class_name<span style="color: #666666">=</span><span style="color: #008000">cls</span><span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>),
                    class_summary<span style="color: #666666">=</span>cls_summary,
                    project_summary<span style="color: #666666">=</span>project_summary,
                )
        <span style="color: #008000; font-weight: bold">for</span> func <span style="color: #AA22FF; font-weight: bold">in</span> module<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;functions&quot;</span>, []):
            src <span style="color: #666666">=</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;signature&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)
            prompt <span style="color: #666666">=</span> _build_function_prompt(src, project_summary<span style="color: #666666">=</span>project_summary)
            func_key <span style="color: #666666">=</span> ResponseCache<span style="color: #666666">.</span>make_key(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>func<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;name&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, prompt)
            func_summary <span style="color: #666666">=</span> _summarize(client, cache, func_key, prompt, <span style="color: #BA2121">&quot;docstring&quot;</span>)
            func[<span style="color: #BA2121">&quot;summary&quot;</span>] <span style="color: #666666">=</span> func_summary
            _rewrite_docstring(
                client,
                cache,
                path,
                func,
                project_summary<span style="color: #666666">=</span>project_summary,
            )

    module_summaries <span style="color: #666666">=</span> {m[<span style="color: #BA2121">&quot;name&quot;</span>]: m<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">for</span> m <span style="color: #AA22FF; font-weight: bold">in</span> modules}
    write_index(<span style="color: #008000">str</span>(output_dir), project_summary, page_links, module_summaries)
    <span style="color: #008000; font-weight: bold">for</span> module <span style="color: #AA22FF; font-weight: bold">in</span> modules:
        write_module_page(<span style="color: #008000">str</span>(output_dir), module, page_links)

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0</span>
</code></pre>
    </div>
</body>
</html>
